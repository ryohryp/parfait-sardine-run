<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ‘ãƒ•ã‚§ã¨ã‚¤ãƒ¯ã‚· RUN!</title>
  <style>
    :root { --maxw: 900px; }
    body{margin:0;background:#eef3f9;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;color:#222;text-align:center}
    header{padding:14px 10px 4px}
    h1{margin:0 0 4px;font-size:clamp(20px,4vw,28px)}
    #hud{font-size:clamp(14px,3.2vw,18px);margin-bottom:8px}
    #wrap{max-width:var(--maxw);margin:0 auto;padding:8px}
    canvas{width:100%;height:auto;max-width:var(--maxw);background:linear-gradient(#9ed6ee,#fff7e6);border:2px solid #333;border-radius:10px;touch-action:none}
    #btns{margin:10px 0}
    button{appearance:none;border:0;border-radius:10px;padding:10px 16px;font-size:16px;background:#22c55e;color:#fff}
    button.secondary{background:#3b82f6}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <header>
    <h1>ãƒ‘ãƒ•ã‚§ã¨ã‚¤ãƒ¯ã‚· RUN!</h1>
    <div id="hud" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </header>
  <div id="wrap">
    <canvas id="cv" width="900" height="420"></canvas>
    <div id="btns">
      <button id="start">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="restart" class="secondary" style="display:none">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
    <p class="muted">æ“ä½œï¼šå·¦åŠåˆ†ã‚¿ãƒƒãƒ—ï¼ã‚¸ãƒ£ãƒ³ãƒ— / å³åŠåˆ†ã‚¿ãƒƒãƒ—ï¼æ”»æ’ƒï¼ˆPC: Space/â†‘ ã§ã‚¸ãƒ£ãƒ³ãƒ—ã€Z/Xã§æ”»æ’ƒï¼‰</p>
  </div>
<script>
(()=>{
  // === åŸºæœ¬ ===
  const cv = document.getElementById('cv');
  const c = cv.getContext('2d');
  const hud = document.getElementById('hud');
  const btnStart = document.getElementById('start');
  const btnRestart = document.getElementById('restart');

  const G = 0.6, JUMP = -12, GROUND = 70;
  const GAME_TIME_MS = 60000;

  let gameOn = false, t0 = 0;
  let lastSpawn = 0, lastEnemy = 0, lastPower = 0, lastShot = 0;
  let score = 0, level = 1, lives = 3, invUntil = 0, hurtUntil = 0;

  const shootCD = 260;               // æ”»æ’ƒã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³(ms)
  const powerMillis = 6000;          // ç„¡æ•µæ™‚é–“
  const enemyHitBonus = 3;           // æ•µæ’ƒç ´ãƒœãƒ¼ãƒŠã‚¹
  const levelUpStep = 15;            // 15ç‚¹ã”ã¨ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—

  const player = { x:110, y:cv.height-GROUND-44, w:44, h:44, vy:0, onGround:true, color:'#ff6347' };

  let items = [];    // ğŸ¨/ğŸŸ
  let enemies = [];  // ğŸ‘¾
  let bullets = [];  // å¼¾
  let powers  = [];  // â­

  // === ä¾¿åˆ©é–¢æ•° ===
  const now = ()=>performance.now();
  const rand = (a,b)=> a + Math.random()*(b-a);
  const AABB = (a,b)=> a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

  function heartStr(n){
    const full = 'â¤ï¸'.repeat(n);
    const empty = 'â™¡'.repeat(3-n);
    return full + empty;
  }

  function setHUD(remainMs){
    const sec = Math.max(0, Math.ceil(remainMs/1000));
    const inv = now() < invUntil ? 'ï¼ˆç„¡æ•µä¸­ï¼‰' : '';
    hud.textContent = `ã‚¹ã‚³ã‚¢: ${score}ã€€ãƒ¬ãƒ™ãƒ«: ${level}ã€€ãƒ©ã‚¤ãƒ•: ${heartStr(lives)}ã€€æ®‹ã‚Š: ${sec}ç§’ ${inv}`;
  }

  // === ã‚¹ãƒãƒ¼ãƒ³ ===
  function spawnItem(){
    const isParfait = Math.random() < 0.5;
    items.push({
      x: cv.width + 24,
      y: cv.height - GROUND - 40 - rand(0, 90),
      w: 30, h: 30,
      v: 3.2 + rand(0, 1.8) + (level-1)*0.2,
      char: isParfait ? 'ğŸ¨' : 'ğŸŸ',
      score: isParfait ? 2 : 1
    });
  }
  function spawnEnemy(){
    enemies.push({
      x: cv.width + 30,
      y: cv.height - GROUND - 34,
      w: 34, h: 34,
      v: 2.8 + (level-1)*0.35
    });
  }
  function spawnPower(){
    powers.push({
      x: cv.width + 26,
      y: cv.height - GROUND - 40 - rand(0, 120),
      w: 26, h: 26,
      v: 3.0 + (level-1)*0.25
    });
  }

  // === å…¥åŠ› ===
  function jump(){
    if (!gameOn) return;
    if (player.onGround){
      player.vy = JUMP;
      player.onGround = false;
    }
  }
  function shoot(){
    if (!gameOn) return;
    const t = now();
    if (t - lastShot < shootCD) return;
    lastShot = t;
    bullets.push({
      x: player.x + player.w,
      y: player.y + player.h/2 - 3,
      w: 10, h: 6, v: 9 + level*0.6
    });
  }

  // ã‚­ãƒ¼å…¥åŠ›ï¼ˆPCç”¨ï¼‰
  window.addEventListener('keydown', e=>{
    if (e.code==='Space' || e.code==='ArrowUp') jump();
    if (e.key==='z' || e.key==='x' || e.key==='Z' || e.key==='X') shoot();
  });

  // ã‚¿ãƒƒãƒï¼ˆå·¦åŠåˆ†ï¼ã‚¸ãƒ£ãƒ³ãƒ—ï¼å³åŠåˆ†ï¼æ”»æ’ƒï¼‰
  cv.addEventListener('touchstart', e=>{
    e.preventDefault();
    const rect = cv.getBoundingClientRect();
    const touch = e.changedTouches[0];
    const x = touch.clientX - rect.left;
    if (x < rect.width/2) jump();
    else shoot();
  }, {passive:false});

  // === æ›´æ–° ===
  function update(t){
    if (!gameOn) return;
    const elapsed = t - t0;
    const remain = GAME_TIME_MS - elapsed;
    if (remain <= 0) return endGame();

    // ãƒ¬ãƒ™ãƒ«æ›´æ–°
    level = Math.max(1, Math.floor(score / levelUpStep) + 1);

    // ç”Ÿæˆé–“éš”ï¼ˆãƒ¬ãƒ™ãƒ«ã§çŸ­ç¸®ï¼‰
    const itemIv  = clamp(1300 - (level-1)*120, 500, 1300);
    const enemyIv = clamp(1700 - (level-1)*140, 600, 1700);
    const powerIv = 6000; // â­ã¯å›ºå®šã‚

    if (t - lastSpawn > itemIv){ spawnItem(); lastSpawn = t; }
    if (t - lastEnemy > enemyIv){ spawnEnemy(); lastEnemy = t; }
    if (t - lastPower > powerIv){ spawnPower(); lastPower = t; }

    // ç‰©ç†
    player.vy += G;
    player.y  += player.vy;
    if (player.y + player.h >= cv.height - GROUND){
      player.y = cv.height - GROUND - player.h;
      player.vy = 0;
      player.onGround = true;
    }

    // å¼¾
    bullets = bullets.filter(b=>{
      b.x += b.v;
      return b.x < cv.width + 20;
    });

    // ã‚¢ã‚¤ãƒ†ãƒ è¡çª
    items = items.filter(it=>{
      it.x -= it.v;
      if (AABB(player, it)){
        score += it.score;
        return false;
      }
      return it.x + it.w > 0;
    });

    // â­è¡çª
    powers = powers.filter(pw=>{
      pw.x -= pw.v;
      if (AABB(player, pw)){
        invUntil = now() + powerMillis;
        return false;
      }
      return pw.x + pw.w > 0;
    });

    // æ•µãƒ»å¼¾ã®è¡çª
    enemies = enemies.filter(en=>{
      en.x -= en.v;
      // å¼¾ãƒ’ãƒƒãƒˆ
      for (let i=0;i<bullets.length;i++){
        if (AABB(en, bullets[i])){
          score += enemyHitBonus;
          bullets.splice(i,1);
          return false;
        }
      }
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¥è§¦
      if (AABB(player, en)){
        if (now() < invUntil){
          score += enemyHitBonus; // ç„¡æ•µä¸­ã¯å€’ã—ãŸæ‰±ã„
          return false;
        }
        if (now() > hurtUntil){
          lives = Math.max(0, lives - 1);
          hurtUntil = now() + 800; // é€£ç¶šãƒ€ãƒ¡è»½æ¸›
          if (lives === 0) { endGame(); return false; }
        }
      }
      return en.x + en.w > 0;
    });

    draw(remain);
    requestAnimationFrame(update);
  }

  // === æç”» ===
  function draw(remainMs){
    c.clearRect(0,0,cv.width,cv.height);
    // åœ°é¢
    c.fillStyle = '#78ad07';
    c.fillRect(0, cv.height-GROUND, cv.width, GROUND);

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    if (now() < invUntil){   // ç„¡æ•µä¸­ã®ç¸å–ã‚Š
      c.strokeStyle = '#f5c542';
      c.lineWidth = 4;
      c.strokeRect(player.x-2, player.y-2, player.w+4, player.h+4);
    }
    if (now() < hurtUntil){  // ãƒ€ãƒ¡ãƒ¼ã‚¸ä¸­ãƒãƒ©ã¤ã
      if (Math.floor(now()/60)%2===0) { /* ã‚¹ã‚­ãƒƒãƒ—ã§ç‚¹æ»… */ }
      else {
        c.fillStyle = player.color;
        c.fillRect(player.x, player.y, player.w, player.h);
      }
    } else {
      c.fillStyle = player.color;
      c.fillRect(player.x, player.y, player.w, player.h);
    }

    // å¼¾
    c.fillStyle = '#333';
    bullets.forEach(b=> c.fillRect(b.x, b.y, b.w, b.h));

    // ã‚¢ã‚¤ãƒ†ãƒ 
    c.font = '28px serif';
    c.textBaseline = 'top';
    items.forEach(it=> c.fillText(it.char, it.x, it.y));

    // â­
    powers.forEach(pw=>{
      c.font = '26px serif';
      c.fillText('â­', pw.x, pw.y);
    });

    // æ•µ
    enemies.forEach(en=>{
      c.font = '32px serif';
      c.fillText('ğŸ‘¾', en.x, en.y-4);
    });

    setHUD(remainMs);
  }

  // === ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»çµ‚äº† ===
  function startGame(){
    score=0; level=1; lives=3; invUntil=0; hurtUntil=0;
    items.length=0; enemies.length=0; bullets.length=0; powers.length=0;
    player.x=110; player.y=cv.height-GROUND-player.h; player.vy=0; player.onGround=true;

    btnStart.style.display='none';
    btnRestart.style.display='none';
    t0 = now();
    gameOn = true;
    lastSpawn = lastEnemy = lastPower = lastShot = t0;
    setHUD(GAME_TIME_MS);
    draw(GAME_TIME_MS);
    requestAnimationFrame(update);
  }
  function endGame(){
    if (!gameOn) return;
    gameOn = false;
    draw(0);
    // çµ‚äº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    c.fillStyle = 'rgba(0,0,0,.55)';
    c.fillRect(0,0,cv.width,cv.height);
    c.fillStyle = '#fff';
    c.textAlign='center';
    c.font = '36px sans-serif';
    c.fillText('ã‚²ãƒ¼ãƒ çµ‚äº†ï¼', cv.width/2, cv.height/2 - 24);
    c.font = '24px sans-serif';
    c.fillText(`æœ€çµ‚ã‚¹ã‚³ã‚¢: ${score}ã€€ãƒ¬ãƒ™ãƒ«: ${level}`, cv.width/2, cv.height/2 + 10);
    c.textAlign='start';
    btnRestart.style.display='inline-block';
  }

  btnStart.addEventListener('click', startGame);
  btnRestart.addEventListener('click', startGame);

  // åˆæœŸHUD
  setHUD(GAME_TIME_MS);
})();
      </script>
