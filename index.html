<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒ‘ãƒ•ã‚§ã¨ã‚¤ãƒ¯ã‚· RUN! â€“ Character Gacha EX</title>
<style>
  :root { --maxw: 920px; }
  * { box-sizing: border-box; }
  body{margin:0;background:#eaf1f8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#222;text-align:center}
  header{padding:12px 8px 4px}
  h1{margin:0 0 6px;font-size:clamp(20px,4vw,28px)}
  #hud{font-size:clamp(13px,3.2vw,18px);margin-bottom:8px}
  #wrap{max-width:var(--maxw);margin:0 auto;padding:8px}
  canvas{width:100%;height:auto;max-width:var(--maxw);background:linear-gradient(#9ed6ee,#fff7e6);border:2px solid #333;border-radius:12px;touch-action:none}
  #btns{display:flex;gap:8px;justify-content:center;margin:10px 0;flex-wrap:wrap}
  button{appearance:none;border:0;border-radius:10px;padding:10px 16px;font-size:16px;background:#22c55e;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.2)}
  button.secondary{background:#3b82f6}
  button.ghost{background:#6b7280}
  button.warn{background:#ef4444}
  button:disabled{opacity:.5}
  .muted{opacity:.75}
  #ultBtn{
    position: fixed; right: 14px; bottom: 18px; z-index: 10;
    padding:12px 16px; border-radius:14px; background:#ef4444; color:#fff; font-weight:700;
    box-shadow:0 3px 0 rgba(0,0,0,.25); user-select:none;
  }
  @media(hover:hover){ #ultBtn:hover{ filter:brightness(1.05); } }

  /* ã‚¬ãƒãƒ£ & ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:20;
    align-items:center; justify-content:center; padding:16px;
  }
  .cardWrap{
    width:min(94vw,820px); background:#111827; color:#fff; border-radius:16px; padding:16px;
    box-shadow:0 8px 32px rgba(0,0,0,.45); text-align:left;
  }
  .cardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cardHeader h2{margin:0;font-size:20px}
  .cardBody{min-height:160px;border:1px solid #374151;border-radius:12px;padding:12px;background:#0b1220}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .miniCard{
    border-radius:12px; padding:10px; text-align:center; min-height:84px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.08); cursor:pointer;
  }
  .rar-c{background:#111827}
  .rar-r{background:linear-gradient(135deg,#1f2937,#0ea5e9)}
  .rar-e{background:linear-gradient(135deg,#3b0764,#a21caf)}
  .rar-l{background:linear-gradient(135deg,#7c2d12,#f59e0b)}
  .rar-m{background:linear-gradient(135deg,#16213e,#22d3ee)}
  .big{font-size:28px}
  .small{font-size:12px;opacity:.85}
  .footerBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  /* å³ä¸Šã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
  #charInfo{position:fixed; right:12px; top:8px; font-size:12px; background:rgba(0,0,0,.5); color:#fff; padding:6px 10px; border-radius:10px}
</style>
</head>
<body>
  <header>
    <h1>ãƒ‘ãƒ•ã‚§ã¨ã‚¤ãƒ¯ã‚· RUN! â€“ Character Gacha EX</h1>
    <div id="hud" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div id="charInfo" class="muted">CHAR: -</div>
  </header>

  <div id="wrap">
    <canvas id="cv" width="900" height="430"></canvas>
    <div id="btns">
      <button id="start">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="restart" class="secondary" style="display:none">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="howto" class="ghost">éŠã³æ–¹</button>
      <button id="gachaOpen" class="warn" disabled>ã‚¬ãƒãƒ£(10)</button>
      <button id="gacha10" class="warn" disabled>10é€£(100)</button>
      <button id="collection" class="ghost">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</button>
    </div>
    <p class="muted">æ“ä½œï¼šå·¦åŠåˆ†ã‚¿ãƒƒãƒ—ï¼ã‚¸ãƒ£ãƒ³ãƒ— / å³åŠåˆ†ã‚¿ãƒƒãƒ—ï¼æ”»æ’ƒ / å³é•·æŠ¼ã— or å³ä¸‹ã®<strong>å¿…æ®º</strong>ï¼å¿…æ®ºæŠ€</p>
  </div>

  <button id="ultBtn" style="display:none">å¿…æ®º</button>

  <!-- ã‚¬ãƒãƒ£ -->
  <div id="gachaOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>ã‚¬ãƒãƒ£çµæœ</h2>
        <button id="gachaClose" class="ghost">é–‰ã˜ã‚‹</button>
      </div>
      <div class="cardBody">
        <div id="gachaResults" class="grid"></div>
      </div>
      <div class="footerBtns">
        <button id="pull1" class="warn">ã‚‚ã†ä¸€åº¦(10)</button>
        <button id="pull10" class="warn">10é€£(100)</button>
      </div>
    </div>
  </div>

  <!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div id="colOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠï¼‰</h2>
        <button id="colClose" class="ghost">é–‰ã˜ã‚‹</button>
      </div>
      <div class="cardBody">
        <div id="colGrid" class="grid"></div>
      </div>
      <div class="footerBtns">
        <button id="colEquip" class="secondary" disabled>ã“ã®ã‚­ãƒ£ãƒ©ã‚’è£…å‚™</button>
      </div>
    </div>
  </div>


  <script>
// ====== ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ‡ãƒãƒƒã‚° ======
(function(){
  // ç”»é¢ã«ã‚¨ãƒ©ãƒ¼å¸¯ã‚’å‡ºã™
  function showErr(msg){
    let bar = document.getElementById('errbar');
    if(!bar){
      bar = document.createElement('div');
      bar.id = 'errbar';
      bar.style.cssText = 'position:fixed;left:0;right:0;top:0;z-index:9999;background:#b91c1c;color:#fff;padding:8px 12px;font-size:12px;font-family:monospace;white-space:pre-wrap';
      document.body.appendChild(bar);
    }
    bar.textContent = '[ERROR] ' + msg;
  }
  window.onerror = function(message, source, lineno, colno, error){
    showErr(`${message} @${lineno}:${colno}`);
  };
  window.onunhandledrejection = function(e){
    showErr('UnhandledRejection: ' + (e.reason && (e.reason.stack || e.reason.message || e.reason)));
  };
})();

// ====== ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’ load å¾Œã«ç¢ºå®Ÿã«èµ·å‹• ======
window.addEventListener('load', function(){
  try{
    // ==== ã“ã“ã‹ã‚‰ä¸‹ã¯ã€å‰å›ãŠæ¸¡ã—ã—ãŸã‚²ãƒ¼ãƒ æœ¬ä½“ã¨åŒç­‰ã§ã™ï¼ˆçŸ­ç¸®ç‰ˆï¼‰ ====
    const cv = document.getElementById('cv');
    const c = cv.getContext('2d');
    const hud = document.getElementById('hud');
    const btnStart = document.getElementById('start');
    const btnRestart = document.getElementById('restart');
    const btnHow = document.getElementById('howto');
    const btnUlt = document.getElementById('ultBtn');
    const btnGacha = document.getElementById('gachaOpen');
    const btnGacha10 = document.getElementById('gacha10');
    const btnCollection = document.getElementById('collection');
    const charInfo = document.getElementById('charInfo');

    // ã‚»ãƒ¼ãƒ•ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    const safeStorage = (function(){
      try{
        const k='__t', s=window.localStorage; s.setItem(k,'1'); s.removeItem(k);
        return {get:(k)=>s.getItem(k), set:(k,v)=>s.setItem(k,v)};
      }catch(e){
        // localStorageãŒä½¿ãˆãªã„ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ç­‰ï¼‰å ´åˆã§ã‚‚å‹•ä½œã™ã‚‹ãƒ¡ãƒ¢ãƒªä»£æ›¿
        const mem={};
        return {get:(k)=>mem[k]||null, set:(k,v)=>{mem[k]=v;}};
      }
    })();

    // ä»¥é™ã®ã‚²ãƒ¼ãƒ æœ¬ä½“ãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾å‹•ãã¯ãšã§ã™
    // ãƒ¼ãƒ¼ãƒ¼ ç•¥ ãƒ¼ãƒ¼ãƒ¼
    // ğŸ’¡ã“ã“ã§å‰å›ã®ã€ŒCharacter Gacha EXã€ã® <script> å†…å®¹ã‚’ãã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„ã€‚
    // ç½®æ›ã®ã‚³ãƒ„ï¼šã“ã®ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã®ç›´å¾Œã‹ã‚‰ã€å‰å›ã‚³ãƒ¼ãƒ‰ã®ã€Œ(() => { â€¦ })();ã€å…¨ä½“ã‚’ä¸¸ã”ã¨è²¼ã‚‹ã€‚
    // ï¼ˆä¸Šã®ãƒ‡ãƒãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ©ã¨ window.load ã ã‘æ®‹ã—ã¦ã€ä¸­èº«ã¯å‰å›ã®ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã«å·®ã—æ›¿ãˆï¼‰
    
    // ===== ã‚µãƒ³ãƒ—ãƒ«: æœ€ä½é™ã®èµ·å‹•ã ã‘ï¼ˆä¸€æ™‚ç¢ºèªç”¨ï¼‰ =====
    // â†“ã¾ãšã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ãŒåå¿œã™ã‚‹ã‹ã®ä¸€æ¬¡ç¢ºèªç”¨ã€‚å‹•ã„ãŸã‚‰ã€ä¸Šã®ã€Œç•¥ã€ã®éƒ¨åˆ†ã«å‰å›ã®æœ¬ä½“ã‚’è²¼ã‚Šæˆ»ã—ã¦ãã ã•ã„ã€‚
    btnStart.onclick = function(){
      hud.textContent = 'èµ·å‹•ãƒ†ã‚¹ãƒˆOKï¼šã‚¹ã‚¿ãƒ¼ãƒˆãŒåå¿œã—ã¾ã—ãŸã€‚å‰å›ã®æœ¬ä½“ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šæˆ»ã—ã¦ãã ã•ã„ã€‚';
      btnStart.style.display='none';
      btnRestart.style.display='inline-block';
      // ã¨ã‚Šã‚ãˆãšèƒŒæ™¯ã‚¯ãƒªã‚¢
      c.clearRect(0,0,cv.width,cv.height);
      c.fillStyle = '#7fb10a';
      c.fillRect(0, cv.height-72, cv.width, 72);
    };
    btnRestart.onclick = ()=>location.reload();

    // åˆæœŸHUD
    hud.textContent = 'èª­ã¿è¾¼ã¿å®Œäº†ã€‚ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã­ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰';
  }catch(e){
    // æœ€åˆæœŸåŒ–ã§è½ã¡ãŸå ´åˆã‚‚ç”»é¢ã«å‡ºã™
    const msg = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e);
    const div = document.createElement('div');
    div.style.cssText = 'position:fixed;left:0;right:0;top:0;z-index:9999;background:#b91c1c;color:#fff;padding:8px 12px;font-size:12px;font-family:monospace;white-space:pre-wrap';
    div.textContent = '[BOOT ERROR] ' + msg;
    document.body.appendChild(div);
  }
});
</script>
