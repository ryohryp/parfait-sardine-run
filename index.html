<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>パフェとイワシ RUN! – Character Gacha EX</title>
<style>
  :root { --maxw: 920px; }
  * { box-sizing: border-box; }
  body{margin:0;background:#eaf1f8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#222;text-align:center}
  header{padding:12px 8px 4px}
  h1{margin:0 0 6px;font-size:clamp(20px,4vw,28px)}
  #hud{font-size:clamp(13px,3.2vw,18px);margin-bottom:8px}
  #wrap{max-width:var(--maxw);margin:0 auto;padding:8px}
  canvas{width:100%;height:auto;max-width:var(--maxw);background:linear-gradient(#9ed6ee,#fff7e6);border:2px solid #333;border-radius:12px;touch-action:none}
  #btns{display:flex;gap:8px;justify-content:center;margin:10px 0;flex-wrap:wrap}
  button{appearance:none;border:0;border-radius:10px;padding:10px 16px;font-size:16px;background:#22c55e;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.2)}
  button.secondary{background:#3b82f6}
  button.ghost{background:#6b7280}
  button.warn{background:#ef4444}
  button:disabled{opacity:.5}
  .muted{opacity:.75}
  #ultBtn{
    position: fixed; right: 14px; bottom: 18px; z-index: 10;
    padding:12px 16px; border-radius:14px; background:#ef4444; color:#fff; font-weight:700;
    box-shadow:0 3px 0 rgba(0,0,0,.25); user-select:none;
  }
  @media(hover:hover){ #ultBtn:hover{ filter:brightness(1.05); } }

  /* ガチャ & コレクション オーバーレイ */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:20;
    align-items:center; justify-content:center; padding:16px;
  }
  .cardWrap{
    width:min(94vw,820px); background:#111827; color:#fff; border-radius:16px; padding:16px;
    box-shadow:0 8px 32px rgba(0,0,0,.45); text-align:left;
  }
  .cardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cardHeader h2{margin:0;font-size:20px}
  .cardBody{min-height:160px;border:1px solid #374151;border-radius:12px;padding:12px;background:#0b1220}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .miniCard{
    border-radius:12px; padding:10px; text-align:center; min-height:84px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.08); cursor:pointer;
  }
  .rar-c{background:#111827}
  .rar-r{background:linear-gradient(135deg,#1f2937,#0ea5e9)}
  .rar-e{background:linear-gradient(135deg,#3b0764,#a21caf)}
  .rar-l{background:linear-gradient(135deg,#7c2d12,#f59e0b)}
  .rar-m{background:linear-gradient(135deg,#16213e,#22d3ee)}
  .big{font-size:28px}
  .small{font-size:12px;opacity:.85}
  .footerBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  /* 右上インジケーター */
  #charInfo{position:fixed; right:12px; top:8px; font-size:12px; background:rgba(0,0,0,.5); color:#fff; padding:6px 10px; border-radius:10px}
</style>
</head>
<body>
  <header>
    <h1>パフェとイワシ RUN! – Character Gacha EX</h1>
    <div id="hud" class="muted">読み込み中…</div>
    <div id="charInfo" class="muted">CHAR: -</div>
  </header>

  <div id="wrap">
    <canvas id="cv" width="900" height="430"></canvas>
    <div id="btns">
      <button id="start">スタート</button>
      <button id="restart" class="secondary" style="display:none">リスタート</button>
      <button id="howto" class="ghost">遊び方</button>
      <button id="gachaOpen" class="warn" disabled>ガチャ(10)</button>
      <button id="gacha10" class="warn" disabled>10連(100)</button>
      <button id="collection" class="ghost">コレクション</button>
    </div>
    <p class="muted">操作：左半分タップ＝ジャンプ / 右半分タップ＝攻撃 / 右長押し or 右下の<strong>必殺</strong>＝必殺技</p>
  </div>

  <button id="ultBtn" style="display:none">必殺</button>

  <!-- ガチャ -->
  <div id="gachaOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>ガチャ結果</h2>
        <button id="gachaClose" class="ghost">閉じる</button>
      </div>
      <div class="cardBody">
        <div id="gachaResults" class="grid"></div>
      </div>
      <div class="footerBtns">
        <button id="pull1" class="warn">もう一度(10)</button>
        <button id="pull10" class="warn">10連(100)</button>
      </div>
    </div>
  </div>

  <!-- コレクション -->
  <div id="colOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>コレクション（タップで選択）</h2>
        <button id="colClose" class="ghost">閉じる</button>
      </div>
      <div class="cardBody">
        <div id="colGrid" class="grid"></div>
      </div>
      <div class="footerBtns">
        <button id="colEquip" class="secondary" disabled>このキャラを装備</button>
      </div>
    </div>
  </div>


  <script>
// ====== ランタイムデバッグ ======
(function(){
  // 画面にエラー帯を出す
  function showErr(msg){
    let bar = document.getElementById('errbar');
    if(!bar){
      bar = document.createElement('div');
      bar.id = 'errbar';
      bar.style.cssText = 'position:fixed;left:0;right:0;top:0;z-index:9999;background:#b91c1c;color:#fff;padding:8px 12px;font-size:12px;font-family:monospace;white-space:pre-wrap';
      document.body.appendChild(bar);
    }
    bar.textContent = '[ERROR] ' + msg;
  }
  window.onerror = function(message, source, lineno, colno, error){
    showErr(`${message} @${lineno}:${colno}`);
  };
  window.onunhandledrejection = function(e){
    showErr('UnhandledRejection: ' + (e.reason && (e.reason.stack || e.reason.message || e.reason)));
  };
})();

// ====== アプリ本体を load 後に確実に起動 ======
window.addEventListener('load', function(){
  try{
    // ==== ここから下は、前回お渡ししたゲーム本体と同等です（短縮版） ====
    const cv = document.getElementById('cv');
    const c = cv.getContext('2d');
    const hud = document.getElementById('hud');
    const btnStart = document.getElementById('start');
    const btnRestart = document.getElementById('restart');
    const btnHow = document.getElementById('howto');
    const btnUlt = document.getElementById('ultBtn');
    const btnGacha = document.getElementById('gachaOpen');
    const btnGacha10 = document.getElementById('gacha10');
    const btnCollection = document.getElementById('collection');
    const charInfo = document.getElementById('charInfo');

    // セーフストレージ
    const safeStorage = (function(){
      try{
        const k='__t', s=window.localStorage; s.setItem(k,'1'); s.removeItem(k);
        return {get:(k)=>s.getItem(k), set:(k,v)=>s.setItem(k,v)};
      }catch(e){
        // localStorageが使えない（プライベートモード等）場合でも動作するメモリ代替
        const mem={};
        return {get:(k)=>mem[k]||null, set:(k,v)=>{mem[k]=v;}};
      }
    })();

    // 以降のゲーム本体ロジックはそのまま動くはずです
    // ーーー 略 ーーー
    // 💡ここで前回の「Character Gacha EX」の <script> 内容をそのまま貼ってください。
    // 置換のコツ：このコメント行の直後から、前回コードの「(() => { … })();」全体を丸ごと貼る。
    // （上のデバッグハンドラと window.load だけ残して、中身は前回のゲームコードに差し替え）
    
    // ===== サンプル: 最低限の起動だけ（一時確認用） =====
    // ↓まず「スタート」ボタンが反応するかの一次確認用。動いたら、上の「略」の部分に前回の本体を貼り戻してください。
    btnStart.onclick = function(){
      hud.textContent = '起動テストOK：スタートが反応しました。前回の本体コードを貼り戻してください。';
      btnStart.style.display='none';
      btnRestart.style.display='inline-block';
      // とりあえず背景クリア
      c.clearRect(0,0,cv.width,cv.height);
      c.fillStyle = '#7fb10a';
      c.fillRect(0, cv.height-72, cv.width, 72);
    };
    btnRestart.onclick = ()=>location.reload();

    // 初期HUD
    hud.textContent = '読み込み完了。スタートを押してね（デバッグ版）';
  }catch(e){
    // 最初期化で落ちた場合も画面に出す
    const msg = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e);
    const div = document.createElement('div');
    div.style.cssText = 'position:fixed;left:0;right:0;top:0;z-index:9999;background:#b91c1c;color:#fff;padding:8px 12px;font-size:12px;font-family:monospace;white-space:pre-wrap';
    div.textContent = '[BOOT ERROR] ' + msg;
    document.body.appendChild(div);
  }
});
</script>
