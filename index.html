<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒ‘ãƒ•ã‚§ã¨ã‚¤ãƒ¯ã‚· RUN! EX</title>
<style>
  :root { --maxw: 920px; }
  * { box-sizing: border-box; }
  body{margin:0;background:#eaf1f8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#222;text-align:center}
  header{padding:12px 8px 4px}
  h1{margin:0 0 6px;font-size:clamp(20px,4vw,28px)}
  #hud{font-size:clamp(13px,3.2vw,18px);margin-bottom:8px}
  #wrap{max-width:var(--maxw);margin:0 auto;padding:8px}
  canvas{width:100%;height:auto;max-width:var(--maxw);background:linear-gradient(#9ed6ee,#fff7e6);border:2px solid #333;border-radius:12px;touch-action:none}
  #btns{display:flex;gap:8px;justify-content:center;margin:10px 0;}
  button{appearance:none;border:0;border-radius:10px;padding:10px 16px;font-size:16px;background:#22c55e;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.2)}
  button.secondary{background:#3b82f6}
  button.ghost{background:#6b7280}
  .muted{opacity:.75}
  /* ãƒ¢ãƒã‚¤ãƒ«å›ºå®šãƒœã‚¿ãƒ³ */
  #ultBtn{
    position: fixed; right: 14px; bottom: 18px; z-index: 10;
    padding:12px 16px; border-radius:14px; background:#ef4444; color:#fff; font-weight:700;
    box-shadow:0 3px 0 rgba(0,0,0,.25); user-select:none;
  }
  @media(hover:hover){ #ultBtn:hover{ filter:brightness(1.05); } }
</style>
</head>
<body>
  <header>
    <h1>ãƒ‘ãƒ•ã‚§ã¨ã‚¤ãƒ¯ã‚· RUN! EX</h1>
    <div id="hud" class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </header>

  <div id="wrap">
    <canvas id="cv" width="900" height="430"></canvas>
    <div id="btns">
      <button id="start">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="restart" class="secondary" style="display:none">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="howto" class="ghost">éŠã³æ–¹</button>
    </div>
    <p class="muted">æ“ä½œï¼šå·¦åŠåˆ†ã‚¿ãƒƒãƒ—ï¼ã‚¸ãƒ£ãƒ³ãƒ— / å³åŠåˆ†ã‚¿ãƒƒãƒ—ï¼æ”»æ’ƒ / å³é•·æŠ¼ã— or å³ä¸‹ã®<strong>å¿…æ®º</strong>ï¼å¿…æ®ºæŠ€</p>
  </div>

  <button id="ultBtn" style="display:none">å¿…æ®º</button>

<script>
(()=>{
// ====== åŸºæœ¬ ======
const cv = document.getElementById('cv');
const c = cv.getContext('2d');
const hud = document.getElementById('hud');
const btnStart = document.getElementById('start');
const btnRestart = document.getElementById('restart');
const btnHow = document.getElementById('howto');
const btnUlt = document.getElementById('ultBtn');

const G = 0.62, JUMP = -12.2, GROUND = 72;
const GAME_TIME = 60000;

let gameOn=false, t0=0;
let lastItem=0, lastEnemy=0, lastPower=0, lastShot=0;
let score=0, level=1, lives=3, invUntil=0, hurtUntil=0;
let ult=0, ultReady=false, ultActiveUntil=0;

const shootCD=250, powerMillis=6000, enemyBonus=3, itemLv=15;
const player = { x:120, y:cv.height-GROUND-46, w:46, h:46, vy:0, onGround:true, color:'#ff6347' };

let items=[], enemies=[], bullets=[], powers=[];

// ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆèƒŒæ™¯ã¨é›£æ˜“åº¦ãƒ–ãƒ¼ã‚¹ãƒˆï¼‰
const stages = [
  { name:'è‰åŸ',  bg1:'#9ed6ee', bg2:'#fff7e6', ground:'#7fb10a', enemyMul:1.00 },
  { name:'ç ‚æ¼ ',  bg1:'#ffd28a', bg2:'#ffe9c7', ground:'#d2a659', enemyMul:1.10 },
  { name:'é›ªåŸ',  bg1:'#c8e7ff', bg2:'#f6fbff', ground:'#b9d3e5', enemyMul:1.22 },
  { name:'å®‡å®™',  bg1:'#0b1833', bg2:'#1b2850', ground:'#0b1833', enemyMul:1.38 },
];
function stageForLevel(lv){
  if (lv>=10) return stages[3];
  if (lv>=7)  return stages[2];
  if (lv>=4)  return stages[1];
  return stages[0];
}

// HUD
function hearts(n){ return 'â¤ï¸'.repeat(n) + 'â™¡'.repeat(3-n); }
function setHUD(remainMs){
  const sec = Math.max(0, Math.ceil(remainMs/1000));
  const inv = now()<invUntil ? 'ï¼ˆç„¡æ•µä¸­ï¼‰' : '';
  const st = stageForLevel(level).name;
  hud.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸:${st}ã€€ã‚¹ã‚³ã‚¢:${score}ã€€ãƒ¬ãƒ™ãƒ«:${level}ã€€ãƒ©ã‚¤ãƒ•:${hearts(lives)}ã€€å¿…æ®º:${ult}%ã€€æ®‹ã‚Š:${sec}ç§’ ${inv}`;
  btnUlt.style.display = ultReady ? 'block':'none';
}

// ä¾¿åˆ©
const now = ()=>performance.now();
const rand = (a,b)=> a + Math.random()*(b-a);
const AABB = (a,b)=> a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

// ã‚¹ãƒãƒ¼ãƒ³
function spawnItem(){
  const isParfait = Math.random()<0.5;
  items.push({
    x: cv.width+24,
    y: cv.height - GROUND - 44 - rand(0, 95),
    w: 30, h: 30,
    v: 3.0 + rand(.6,1.8) + (level-1)*.22,
    char: isParfait ? 'ğŸ¨' : 'ğŸŸ',
    score: isParfait ? 2 : 1
  });
}
function spawnEnemy(){
  const st = stageForLevel(level);
  enemies.push({
    x: cv.width+30,
    y: cv.height - GROUND - 36,
    w: 36, h: 36,
    v: (2.7 + (level-1)*.35) * st.enemyMul
  });
}
function spawnPower(){
  powers.push({
    x: cv.width+26,
    y: cv.height - GROUND - 44 - rand(0, 120),
    w: 26, h: 26,
    v: 3.0 + (level-1)*.25
  });
}

// å…¥åŠ›
function jump(){
  if (!gameOn) return;
  if (player.onGround){ player.vy=JUMP; player.onGround=false; }
}
function shoot(){
  if (!gameOn) return;
  const t=now(); if (t-lastShot<shootCD) return;
  lastShot=t;
  bullets.push({ x:player.x+player.w, y:player.y+player.h/2-3, w:12, h:6, v:9+level*.6 });
}
function tryUlt(){
  if (!gameOn||!ultReady) return;
  ultReady=false; ult=0;
  ultActiveUntil = now()+1200; // 1.2ç§’ãƒ“ãƒ¼ãƒ 
}

// PCã‚­ãƒ¼
window.addEventListener('keydown', e=>{
  if (e.code==='Space' || e.code==='ArrowUp') jump();
  if (e.key==='z'||e.key==='x'||e.key==='Z'||e.key==='X') shoot();
  if (e.key==='c' || e.key==='C') tryUlt();
});

// ã‚¿ãƒƒãƒï¼ˆå·¦ï¼ã‚¸ãƒ£ãƒ³ãƒ—ã€å³ï¼æ”»æ’ƒ or é•·æŠ¼ã—ã§å¿…æ®ºï¼‰
let pressTimer=null, pressedRight=false;
cv.addEventListener('touchstart', e=>{
  e.preventDefault();
  const rect=cv.getBoundingClientRect();
  const x=e.changedTouches[0].clientX - rect.left;
  const isLeft = x < rect.width/2;
  if (isLeft){ jump(); pressedRight=false; }
  else {
    pressedRight=true;
    pressTimer=setTimeout(()=>{ if(pressedRight) tryUlt(); }, 350); // 0.35ç§’ã§å¿…æ®º
    shoot();
  }
},{passive:false});
cv.addEventListener('touchend', ()=>{ pressedRight=false; clearTimeout(pressTimer); }, {passive:true});
btnUlt.addEventListener('click', tryUlt);

// æ›´æ–°
function update(t){
  if(!gameOn) return;
  const elapsed=t-t0, remain=GAME_TIME-elapsed;
  if (remain<=0) return endGame();

  // ãƒ¬ãƒ™ãƒ«
  level = Math.max(1, Math.floor(score/itemLv)+1);
  const st = stageForLevel(level);

  // ç”Ÿæˆé–“éš”ï¼ˆãƒ¬ãƒ™ãƒ«ã§çŸ­ç¸®ï¼‰
  const itemIv  = clamp(1200 - (level-1)*100, 480, 1200);
  const enemyIv = clamp(1650 - (level-1)*130, 600, 1650);
  const powerIv = 6200;

  if(t-lastItem  > itemIv)  { spawnItem();  lastItem=t; }
  if(t-lastEnemy > enemyIv) { spawnEnemy(); lastEnemy=t; }
  if(t-lastPower > powerIv) { spawnPower(); lastPower=t; }

  // ç‰©ç†
  player.vy += G; player.y += player.vy;
  if (player.y+player.h >= cv.height-GROUND){
    player.y=cv.height-GROUND-player.h; player.vy=0; player.onGround=true;
  }

  // å¼¾
  bullets = bullets.filter(b=> (b.x+=b.v) < cv.width+24 );

  // ã‚¢ã‚¤ãƒ†ãƒ 
  items = items.filter(it=>{
    it.x -= it.v;
    if (AABB(player,it)){
      score += it.score; ult = clamp(ult + (it.char==='ğŸ¨'?10:6), 0, 100);
      return false;
    }
    return it.x+it.w>0;
  });

  // â­
  powers = powers.filter(pw=>{
    pw.x -= pw.v;
    if (AABB(player,pw)){ invUntil=now()+powerMillis; ult = clamp(ult+12,0,100); return false; }
    return pw.x+pw.w>0;
  });

  // å¿…æ®ºæº–å‚™
  if (ult>=100) ultReady=true;

  // æ•µ
  enemies = enemies.filter(en=>{
    en.x -= en.v;

    // å¿…æ®ºãƒ“ãƒ¼ãƒ åˆ¤å®šï¼ˆç”»é¢æ¨ªæ–­ï¼‰
    if (now()<ultActiveUntil){
      // ãƒ“ãƒ¼ãƒ ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®èƒ¸ã®é«˜ã•ã§æ¨ªä¸€ç›´ç·š
      const beamY = player.y + player.h/2;
      const hit = (en.y-6 <= beamY && beamY <= en.y+en.h+6);
      if (hit){ score += enemyBonus; return false; }
    }

    // å¼¾ãƒ’ãƒƒãƒˆ
    for (let i=0;i<bullets.length;i++){
      if (AABB(en,bullets[i])){ score+=enemyBonus; ult=clamp(ult+8,0,100); bullets.splice(i,1); return false; }
    }

    // ä½“å½“ãŸã‚Š
    if (AABB(player,en)){
      if (now()<invUntil){ score+=enemyBonus; return false; }
      if (now()>hurtUntil){
        lives=Math.max(0,lives-1); hurtUntil=now()+900;
        if (lives===0){ endGame(); return false; }
      }
    }
    return en.x+en.w>0;
  });

  draw(remain, st);
  requestAnimationFrame(update);
}

// æç”»
function draw(remain, st){
  // èƒŒæ™¯
  const g=c.createLinearGradient(0,0,0,cv.height);
  g.addColorStop(0, st.bg1); g.addColorStop(1, st.bg2);
  c.fillStyle=g; c.fillRect(0,0,cv.width,cv.height);

  // åœ°é¢
  c.fillStyle=st.ground; c.fillRect(0, cv.height-GROUND, cv.width, GROUND);

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç„¡æ•µ/ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡ºï¼‰
  if (now()<invUntil){ c.strokeStyle='#f5c542'; c.lineWidth=4; c.strokeRect(player.x-2,player.y-2,player.w+4,player.h+4); }
  const blink = now()<hurtUntil && Math.floor(now()/60)%2===0;
  if (!blink){ c.fillStyle=player.color; c.fillRect(player.x,player.y,player.w,player.h); }

  // ãƒ“ãƒ¼ãƒ 
  if (now()<ultActiveUntil){
    const y = player.y + player.h/2;
    c.fillStyle='rgba(255,80,80,.7)';
    c.fillRect(player.x, y-6, cv.width-player.x, 12);
    c.fillStyle='rgba(255,255,255,.6)';
    c.fillRect(player.x, y-2, cv.width-player.x, 4);
  }

  // å¼¾
  c.fillStyle='#333'; bullets.forEach(b=> c.fillRect(b.x,b.y,b.w,b.h));

  // ã‚¢ã‚¤ãƒ†ãƒ 
  c.font='28px serif'; c.textBaseline='top';
  items.forEach(it=> c.fillText(it.char,it.x,it.y));

  // â­
  powers.forEach(pw=>{ c.font='26px serif'; c.fillText('â­', pw.x, pw.y); });

  // æ•µ
  enemies.forEach(en=>{ c.font='32px serif'; c.fillText('ğŸ‘¾', en.x, en.y-4); });

  // HUD
  setHUD(remain);
}

// ã‚²ãƒ¼ãƒ é–‹å§‹/çµ‚äº†
function startGame(){
  score=0; level=1; lives=3; invUntil=0; hurtUntil=0; ult=0; ultReady=false; ultActiveUntil=0;
  items.length=0; enemies.length=0; bullets.length=0; powers.length=0;
  player.x=120; player.y=cv.height-GROUND-player.h; player.vy=0; player.onGround=true;
  btnStart.style.display='none'; btnRestart.style.display='none';
  t0=now(); gameOn=true;
  lastItem=lastEnemy=lastPower=lastShot=t0;
  setHUD(GAME_TIME); draw(GAME_TIME, stageForLevel(level));
  requestAnimationFrame(update);
}
function endGame(){
  if(!gameOn) return; gameOn=false;
  const st = stageForLevel(level);
  draw(0, st);
  c.fillStyle='rgba(0,0,0,.55)'; c.fillRect(0,0,cv.width,cv.height);
  c.fillStyle='#fff'; c.textAlign='center';
  c.font='36px sans-serif'; c.fillText('ã‚²ãƒ¼ãƒ çµ‚äº†ï¼', cv.width/2, cv.height/2 - 24);
  c.font='24px sans-serif'; c.fillText(`æœ€çµ‚ã‚¹ã‚³ã‚¢: ${score}ã€€ãƒ¬ãƒ™ãƒ«: ${level}`, cv.width/2, cv.height/2 + 10);
  c.textAlign='start'; btnRestart.style.display='inline-block';
}

// ãƒœã‚¿ãƒ³
btnStart.addEventListener('click', startGame);
btnRestart.addEventListener('click', startGame);
btnHow.addEventListener('click', ()=>{
  alert('æ“ä½œ: å·¦ï¼ã‚¸ãƒ£ãƒ³ãƒ— / å³ï¼æ”»æ’ƒ / å³é•·æŠ¼ã— or å³ä¸‹ã®ã€Œå¿…æ®ºã€ï¼å¿…æ®ºæŠ€ï¼ˆã‚²ãƒ¼ã‚¸100%å¿…è¦ï¼‰\nãƒ»ã‚¢ã‚¤ãƒ†ãƒ ğŸ¨/ğŸŸã§ã‚¹ã‚³ã‚¢ & å¿…æ®ºã‚²ãƒ¼ã‚¸UP\nãƒ»â­ã§ç„¡æ•µï¼ˆç´„6ç§’ï¼‰\nãƒ»15ç‚¹ã”ã¨ã«ãƒ¬ãƒ™ãƒ«UPã€‚Lvã«å¿œã˜ã¦ã‚¹ãƒ†ãƒ¼ã‚¸ã¨é›£æ˜“åº¦ãŒå¤‰åŒ–ã—ã¾ã™ã€‚');
});

// åˆæœŸHUD
setHUD(GAME_TIME);
})();
</script>
</body>
</html>
