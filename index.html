<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>パフェとイワシ RUN! – Character Gacha EX</title>
<style>
  :root { --maxw: 920px; }
  * { box-sizing: border-box; }
  body{margin:0;background:#eaf1f8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;color:#222;text-align:center}
  header{padding:12px 8px 4px}
  h1{margin:0 0 6px;font-size:clamp(20px,4vw,28px)}
  #hud{
    font-size:clamp(13px,3.2vw,18px);
    margin:0 auto 12px;
    max-width:var(--maxw);
    display:flex;
    flex-direction:column;
    gap:6px;
    text-align:left;
    background:rgba(255,255,255,.85);
    color:#111827;
    border-radius:12px;
    padding:10px 14px;
    box-shadow:0 6px 22px rgba(15,23,42,.12);
  }
  .hudRow{display:flex;flex-wrap:wrap;gap:8px 16px;align-items:center}
  .hudItem{display:inline-flex;align-items:center;gap:6px;line-height:1.4}
  .hudItem strong{font-size:.78em;letter-spacing:.08em;color:#2563eb;text-transform:uppercase}
  .hudItem .value{font-weight:600}
  .hudTag{display:inline-flex;align-items:center;padding:2px 8px;background:#facc15;color:#111827;border-radius:999px;font-size:.75em;font-weight:600}
  .hudHearts{font-size:1.05em}
  .hudCoins{gap:4px}
  #wrap{max-width:var(--maxw);margin:0 auto;padding:8px}
  canvas{width:100%;height:auto;max-width:var(--maxw);background:linear-gradient(#9ed6ee,#fff7e6);border:2px solid #333;border-radius:12px;touch-action:none}
  #btns{display:flex;gap:8px;justify-content:center;margin:10px 0;flex-wrap:wrap}
  button{appearance:none;border:0;border-radius:10px;padding:10px 16px;font-size:16px;background:#22c55e;color:#fff;box-shadow:0 2px 0 rgba(0,0,0,.2)}
  button.secondary{background:#3b82f6}
  button.ghost{background:#6b7280}
  button.warn{background:#ef4444}
  button:disabled{opacity:.5}
  .leaderboardList{list-style:none;margin:12px 0 0;padding:0;display:grid;gap:8px}
  .leaderboardItem{background:#1f2937;border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;align-items:flex-start;text-align:left}
  .leaderboardTitle{font-weight:600;color:#f9fafb;font-size:15px}
  .leaderboardMeta{font-size:12px;color:rgba(229,231,235,.8);margin-top:4px;display:flex;flex-wrap:wrap;gap:6px}
  .muted{opacity:.75}
  .controls{max-width:var(--maxw);margin:0 auto;line-height:1.6;text-align:left}
  #objective{
    max-width:var(--maxw);
    margin:0 auto 14px;
    text-align:left;
    background:#111827;
    color:#f9fafb;
    border-radius:16px;
    padding:14px 18px;
    box-shadow:0 14px 28px rgba(15,23,42,.28);
  }
  #objective h2{margin:0 0 6px;font-size:clamp(18px,3.2vw,24px)}
  #objective p{margin:0 0 8px;line-height:1.65}
  #objective ul{margin:0;padding-left:22px;display:grid;gap:4px;font-size:clamp(12px,3.2vw,16px)}
  #objective li::marker{color:#facc15}
  #objective strong{color:#fbbf24}
  #ultBtn{
    position: fixed; right: 14px; bottom: 18px; z-index: 10;
    padding:12px 16px; border-radius:14px; background:#ef4444; color:#fff; font-weight:700;
    box-shadow:0 3px 0 rgba(0,0,0,.25); user-select:none;
  }
  @media(hover:hover){ #ultBtn:hover{ filter:brightness(1.05); } }

  /* ガチャ & コレクション オーバーレイ */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:20;
    align-items:center; justify-content:center; padding:16px;
  }
  .cardWrap{
    width:min(94vw,820px); background:#111827; color:#fff; border-radius:16px; padding:16px;
    box-shadow:0 8px 32px rgba(0,0,0,.45); text-align:left;
  }
  .cardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cardHeader h2{margin:0;font-size:20px}
  .cardBody{min-height:160px;border:1px solid #374151;border-radius:12px;padding:12px;background:#0b1220}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .miniCard{
    border-radius:12px; padding:10px; text-align:center; min-height:84px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.08); cursor:pointer;
  }
  .howList{display:grid;gap:8px;margin:12px 0 0;padding-left:20px;line-height:1.6}
  .howList li::marker{color:#3b82f6;font-weight:700}
  .howLead{margin:8px 0 0;line-height:1.6}
  .howFooter{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-top:16px}
  .howFooterNote{font-size:13px;opacity:.75}
  .rar-c{background:#111827}
  .rar-r{background:linear-gradient(135deg,#1f2937,#0ea5e9)}
  .rar-e{background:linear-gradient(135deg,#3b0764,#a21caf)}
  .rar-l{background:linear-gradient(135deg,#7c2d12,#f59e0b)}
  .rar-m{background:linear-gradient(135deg,#16213e,#22d3ee)}
  .big{font-size:28px}
  .small{font-size:12px;opacity:.85}
  .footerBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

  /* 右上インジケーター */
  #charInfo{position:fixed; right:12px; top:8px; font-size:12px; background:rgba(0,0,0,.5); color:#fff; padding:6px 10px; border-radius:10px}
</style>
</head>
<body>
  <header>
    <h1>パフェとイワシ RUN! – Character Gacha EX</h1>
    <div id="hud" class="muted">読み込み中…</div>
    <div id="charInfo" class="muted">CHAR: -</div>
  </header>

  <section id="objective">
    <h2>ゲームの目的</h2>
    <p>令和スタイルのラン＆シュートで、<strong>60秒以内にベストスコアを叩き出し</strong>つつコインを稼ぎ、コレクションを増やしましょう。</p>
    <ul>
      <li><strong>アイテムを集めて</strong>スコアとコインを獲得。集めたコインでガチャを回し、新しいキャラを開放！</li>
      <li><strong>ジャンプと攻撃で敵をかわしつつ撃破</strong>。連続ヒットでスコアがぐんぐん伸びます。</li>
      <li><strong>必殺技ゲージが100%になったら一気に反撃</strong>。キャラ固有のスキルを活かしてハイスコアを狙いましょう。</li>
    </ul>
  </section>

  <div id="wrap">
    <canvas id="cv" width="900" height="430"></canvas>
    <div id="btns">
      <button id="start">スタート</button>
      <button id="restart" class="secondary" style="display:none">リスタート</button>
      <button id="howto" class="ghost">遊び方</button>
      <button id="gachaOpen" class="warn" disabled>ガチャ(10)</button>
      <button id="gacha10" class="warn" disabled>10連(100)</button>
      <button id="collection" class="ghost">コレクション</button>
      <button id="leaderboardBtn" class="ghost">ランキング</button>
    </div>
    <p class="muted controls"><strong>操作ヒント：</strong>画面左側タップ/クリック＝ジャンプ、右側＝攻撃、右長押し or 右下の<strong>必殺</strong>ボタン＝必殺技（ゲージ100%時）。</p>
  </div>

  <button id="ultBtn" style="display:none">必殺</button>

  <!-- 遊び方 -->
  <div id="howOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>遊び方ガイド</h2>
        <button id="howClose" class="ghost">閉じる</button>
      </div>
      <div class="cardBody">
        <p id="howLead" class="howLead">60秒でベストスコアを更新し、コインでガチャを解放してキャラ図鑑を充実させましょう。</p>
        <ul class="howList">
          <li>画面左タップ/クリックでジャンプ。二段ジャンプ可能なキャラもいます。</li>
          <li>画面右タップで攻撃、長押し or 右下の<strong>必殺</strong>ボタンでゲージ100%時の必殺技を発動。</li>
          <li>🍨や🐟アイテムでスコア＆コイン、⭐で無敵とゲージUP。敵を倒すとさらにボーナス。</li>
          <li>集めたコインでガチャを回し、キャラを装備して能力を入れ替えましょう。</li>
        </ul>
      </div>
      <div class="howFooter">
        <span class="howFooterNote">ヒント：ベストスコアは自動保存。連続プレイで令和チャンプを目指そう！</span>
        <button id="howStart" class="secondary">今すぐプレイ</button>
      </div>
    </div>
  </div>

  <!-- ガチャ -->
  <div id="gachaOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>ガチャ結果</h2>
        <button id="gachaClose" class="ghost">閉じる</button>
      </div>
      <div class="cardBody">
        <div id="gachaResults" class="grid"></div>
      </div>
      <div class="footerBtns">
        <button id="pull1" class="warn">もう一度(10)</button>
        <button id="pull10" class="warn">10連(100)</button>
      </div>
    </div>
  </div>

  <!-- コレクション -->
  <div id="colOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>コレクション（タップで選択）</h2>
        <button id="colClose" class="ghost">閉じる</button>
      </div>
      <div class="cardBody">
        <div id="colGrid" class="grid"></div>
      </div>
      <div class="footerBtns">
        <button id="colEquip" class="secondary" disabled>このキャラを装備</button>
      </div>
    </div>
  </div>

  <!-- ランキング -->
  <div id="leaderboardOverlay" class="overlay">
    <div class="cardWrap">
      <div class="cardHeader">
        <h2>ランキング</h2>
        <button id="leaderboardClose" class="ghost">閉じる</button>
      </div>
      <div class="cardBody">
        <p id="leaderboardStatus" class="howLead">読み込み中…</p>
        <ol id="leaderboardList" class="leaderboardList"></ol>
      </div>
      <div class="footerBtns">
        <button id="leaderboardRefresh" class="secondary">更新</button>
      </div>
    </div>
  </div>


<script>
(()=>{
// ====== 基本 ======
const cv = document.getElementById('cv');
const c = cv.getContext('2d');
const hud = document.getElementById('hud');
const btnStart = document.getElementById('start');
const btnRestart = document.getElementById('restart');
const btnHow = document.getElementById('howto');
const btnUlt = document.getElementById('ultBtn');
const btnGacha = document.getElementById('gachaOpen');
const btnGacha10 = document.getElementById('gacha10');
const btnCollection = document.getElementById('collection');
const btnLeaderboard = document.getElementById('leaderboardBtn');
const charInfo = document.getElementById('charInfo');
const howOverlay = document.getElementById('howOverlay');
const howClose = document.getElementById('howClose');
const howStart = document.getElementById('howStart');
const howLead = document.getElementById('howLead');

// ガチャUI
const ov = document.getElementById('gachaOverlay');
const resWrap = document.getElementById('gachaResults');
document.getElementById('gachaClose').onclick = ()=> ov.style.display='none';
document.getElementById('pull1').onclick = ()=> doGacha(1);
document.getElementById('pull10').onclick = ()=> doGacha(10);

// コレクションUI
const colOv = document.getElementById('colOverlay');
const colGrid = document.getElementById('colGrid');
const colClose = document.getElementById('colClose');
const colEquip = document.getElementById('colEquip');
let colSelectedKey = null;
colClose.onclick = ()=>{ colOv.style.display='none'; colSelectedKey=null; colEquip.disabled=true; };
colEquip.onclick = ()=>{ if(colSelectedKey){ setCurrentChar(colSelectedKey); colOv.style.display='none'; } };

// ランキングUI
const lbOverlay = document.getElementById('leaderboardOverlay');
const lbClose = document.getElementById('leaderboardClose');
const lbRefresh = document.getElementById('leaderboardRefresh');
const lbStatus = document.getElementById('leaderboardStatus');
const lbList = document.getElementById('leaderboardList');
if (lbClose){ lbClose.onclick = ()=>{ lbOverlay.style.display='none'; }; }
if (btnLeaderboard){ btnLeaderboard.onclick = ()=>{ openLeaderboardOverlay(); }; }
if (lbRefresh){ lbRefresh.onclick = ()=>{ loadLeaderboard(true); }; }

const PLAYER_NAME_KEY = 'psrun_player_name_v1';
const DEFAULT_PLAYER_NAME = 'プレイヤー';

function leaderboardUrl(){
  const base = (typeof window !== 'undefined' && window.PSRUN_API_BASE)
    ? String(window.PSRUN_API_BASE).trim().replace(/\/$/, '')
    : 'https://howasaba-code.com/wp-json/psrun/v1';
  return base.endsWith('/leaderboard') ? base : `${base}/leaderboard`;
}

function sanitizeName(raw){
  if (!raw) return '';
  return String(raw).replace(/[\u0000-\u001F\u007F<>]/g,'').trim().slice(0, 32);
}

function loadPlayerName(){
  try{ return localStorage.getItem(PLAYER_NAME_KEY) || ''; }
  catch{ return ''; }
}

function savePlayerName(name){
  try{ localStorage.setItem(PLAYER_NAME_KEY, name); }
  catch{}
}

function openLeaderboardOverlay(){
  if (!lbOverlay) return;
  lbOverlay.style.display='flex';
  loadLeaderboard(true);
}

function describeCharLabel(key){
  if (!key) return '-';
  const ch = characters?.[key];
  return ch ? `${ch.emoji} ${ch.name}` : key;
}

async function loadLeaderboard(showLoading){
  if (!lbList || !lbStatus) return;
  if (showLoading){
    lbStatus.textContent = '読み込み中…';
    lbStatus.style.display = 'block';
  }
  lbList.innerHTML = '';
  try{
    const res = await fetch(leaderboardUrl(), { method:'GET', headers:{ 'Accept':'application/json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const raw = await res.json();
    const entries = normalizeLeaderboardEntries(raw);
    if (!entries.length){

      lbStatus.textContent = 'No results yet';
      lbStatus.style.display = 'block';
      return;
    }
    lbStatus.textContent = '';
    lbStatus.style.display = 'none';

    entries.slice(0, 20).forEach((entry, idx)=>{

      const li = document.createElement('li');
      li.className = 'leaderboardItem';
      const title = document.createElement('div');
      title.className = 'leaderboardTitle';
      title.textContent = `#${idx+1} ${entry?.name ? String(entry.name) : '匿名'}`;
      const meta = document.createElement('div');
      meta.className = 'leaderboardMeta';

      const scoreSpan = document.createElement('span');
      scoreSpan.textContent = `Score: ${Number(entry?.score) || 0}`;
      meta.appendChild(scoreSpan);

      const levelSpan = document.createElement('span');
      levelSpan.textContent = `Lv: ${Number(entry?.level) || 1}`;
      meta.appendChild(levelSpan);

      const coinsSpan = document.createElement('span');
      coinsSpan.textContent = `Coins: ${Number(entry?.coins) || 0}`;
      meta.appendChild(coinsSpan);

      const charSpan = document.createElement('span');
      charSpan.textContent = `Char: ${describeCharLabel(entry?.char)}`;
      meta.appendChild(charSpan);

      if (entry?.time){
        const timeSpan = document.createElement('span');
        timeSpan.textContent = `Time: ${String(entry.time)}`;
        meta.appendChild(timeSpan);
      }

      li.appendChild(title);
      li.appendChild(meta);
      lbList.appendChild(li);
    });
  }catch(err){
    console.error('Failed to load leaderboard', err);
    lbStatus.textContent = 'ランキングを取得できませんでした。';
    lbStatus.style.display = 'block';
  }
}


function normalizeLeaderboardEntries(raw){
  if (Array.isArray(raw)){
    return raw;
  }
  if (!raw || typeof raw !== 'object'){
    if (typeof raw === 'string'){
      try{ return normalizeLeaderboardEntries(JSON.parse(raw)); }
      catch{ return []; }
    }
    return [];
  }
  if (Array.isArray(raw.data)){
    return raw.data;
  }
  if (Array.isArray(raw.leaderboard)){
    return raw.leaderboard;
  }
  if (Array.isArray(raw.results)){
    return raw.results;
  }
  if (raw.data && typeof raw.data === 'object'){
    const nested = normalizeLeaderboardEntries(raw.data);
    if (nested.length) return nested;
  }
  return [];
}


async function submitLeaderboardScore(name, result){
  const payload = {
    name,
    score: Math.max(0, Math.floor(Number(result?.score) || 0)),
    level: Math.max(1, Math.floor(Number(result?.level) || 1)),
    coins: Math.max(0, Math.floor(Number(result?.coins) || 0)),
    char: result?.char || ''
  };
  try{
    const res = await fetch(leaderboardUrl(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    await res.json().catch(()=> ({}));
    return true;
  }catch(err){
    console.error('Failed to submit leaderboard', err);
    if (lbStatus){
      lbStatus.textContent = 'ランキングへの送信に失敗しました。';
      lbStatus.style.display = 'block';
    }
    return false;
  }
}

async function handleLeaderboardAfterGame(result){
  if (lbOverlay){
    lbOverlay.style.display = 'flex';
  }
  if (!result || result.score<=0){
    await loadLeaderboard(true);
    return;
  }
  const stored = loadPlayerName() || DEFAULT_PLAYER_NAME;
  const input = prompt(`ランキングにスコア(${result.score})を登録します。名前を入力してください。`, stored);
  if (input===null){
    await loadLeaderboard(true);
    return;
  }
  const name = sanitizeName(input);
  if (!name){
    alert('名前が空のため送信をスキップしました。');
    await loadLeaderboard(true);
    return;
  }
  savePlayerName(name);
  const ok = await submitLeaderboardScore(name, result);
  if (!ok){
    alert('ランキングへの送信に失敗しました。通信状況をご確認ください。');
  }
  await loadLeaderboard(true);
}

function openHowto(initial=false){
  if (!howOverlay) return;
  if (howLead){
    howLead.textContent = initial
      ? 'まずは操作をチェック！60秒ランでベストスコアを狙い、コインでキャラを集めましょう。'
      : '困ったらいつでもここで操作と目的を確認できます。';
  }
  howOverlay.style.display='flex';
}

if (btnHow){
  btnHow.addEventListener('click', ()=> openHowto(false));
}
if (howClose){
  howClose.addEventListener('click', ()=>{ howOverlay.style.display='none'; });
}
if (howStart){
  howStart.addEventListener('click', ()=>{
    howOverlay.style.display='none';
    if (!gameOn) startGame();
  });
}
const INTRO_KEY = 'psrun_intro_seen_v2';
try{
  if (!localStorage.getItem(INTRO_KEY)){
    openHowto(true);
    localStorage.setItem(INTRO_KEY,'1');
  }
}catch{
  openHowto(true);
}

// 物理 & ゲーム基本
const G = 0.62, BASE_JUMP = -12.2, GROUND = 72;
const GAME_TIME = 60000;

let gameOn=false, t0=0;
let lastItem=0, lastEnemy=0, lastPower=0, lastShot=0;
let score=0, level=1, lives=3, invUntil=0, hurtUntil=0;
let ult=0, ultReady=false, ultActiveUntil=0;
let coins=0; // ガチャ用
let autoShootUntil=0, bulletBoostUntil=0, scoreMulUntil=0;

const shootCD=250, powerMillis=6000, enemyBonus=3, itemLv=15;
const player = { x:120, y:cv.height-GROUND-46, w:46, h:46, vy:0, onGround:true, color:'#ff6347' };

let items=[], enemies=[], bullets=[], powers=[], ultProjectiles=[];

// ステージ
const stages = [
  { name:'草原',  bg1:'#9ed6ee', bg2:'#fff7e6', ground:'#7fb10a', enemyMul:1.00 },
  { name:'砂漠',  bg1:'#ffd28a', bg2:'#ffe9c7', ground:'#d2a659', enemyMul:1.10 },
  { name:'雪原',  bg1:'#c8e7ff', bg2:'#f6fbff', ground:'#b9d3e5', enemyMul:1.22 },
  { name:'宇宙',  bg1:'#0b1833', bg2:'#1b2850', ground:'#0b1833', enemyMul:1.38 },
];
function stageForLevel(lv){
  if (lv>=10) return stages[3];
  if (lv>=7)  return stages[2];
  if (lv>=4)  return stages[1];
  return stages[0];
}

// ====== キャラ定義 ======
/*
  各値は倍率/ミリ秒。
  special: ['magnet','oneGuard','doubleJump','pierce']
  ult: 'rainbow' | 'storm' | 'ncha' | 'yadon' | null
*/
const characters = {
  // Common
  parfen:   { key:'parfen',   name:'🍓パフェン',    emoji:'🍓', rar:'C', move:1.00, jump:1.00, bullet:1.00, inv:6000, ultRate:1.00, special:[],             ult:null },
  iwassy:   { key:'iwassy',   name:'🐟イワッシー',  emoji:'🐟', rar:'C', move:1.00, jump:1.10, bullet:1.00, inv:6000, ultRate:1.00, special:['airAttack'], ult:null },

  // Rare
  choco:    { key:'choco',    name:'🍫チョコパフェン', emoji:'🍫', rar:'R', move:1.00, jump:1.00, bullet:1.15, inv:7000, ultRate:1.00, special:[],           ult:null },
  missile:  { key:'missile',  name:'🚀ミサイル君',   emoji:'🚀', rar:'R', move:1.10, jump:1.00, bullet:1.00, inv:6000, ultRate:1.05, special:[],           ult:null },

  // Epic
  ice:      { key:'ice',      name:'❄️アイス皇帝',  emoji:'❄️', rar:'E', move:1.00, jump:1.20, bullet:1.00, inv:6000, ultRate:1.00, special:['slowEnemy'], ult:null },

  // Legendary
  king:     { key:'king',     name:'👑キングパフェ', emoji:'👑', rar:'L', move:1.15, jump:1.10, bullet:1.10, inv:7000, ultRate:1.20, special:[], ult:'rainbow' },
  ncha:     { key:'ncha',     name:'🤖んちゃマシン', emoji:'🤖', rar:'L', move:1.20, jump:1.05, bullet:1.25, inv:6800, ultRate:1.25, special:['pierce'], ult:'ncha' },

  // Mythic
  aurora:   { key:'aurora',   name:'🌈オーロラパフェ', emoji:'🌈', rar:'M', move:1.18, jump:1.12, bullet:1.15, inv:8000, ultRate:1.35, special:['magnet','oneGuard'], ult:'rainbow' },
  iwashiK:  { key:'iwashiK',  name:'🌀トルネード鰯王', emoji:'🌀', rar:'M', move:1.15, jump:1.20, bullet:1.10, inv:7000, ultRate:1.30, special:['doubleJump','pierce'], ult:'storm' },
  yadon:    { key:'yadon',    name:'🦛まったりヤドン', emoji:'🦛', rar:'M', move:0.98, jump:1.08, bullet:1.05, inv:8500, ultRate:1.45, special:['magnet'], ult:'yadon' },
};

// レア→カラー/順序
const rarOrder = ['C','R','E','L','M'];
function rarClass(r){ return r==='M'?'rar-m':r==='L'?'rar-l':r==='E'?'rar-e':r==='R'?'rar-r':'rar-c'; }

// 所持データ（localStorage）
const STORE_KEY = 'psrun_char_collection_v1';
const BEST_SCORE_KEY = 'psrun_best_score_v1';
let collection = loadCollection();
let currentCharKey = collection.current || 'parfen';
if(!collection.owned[currentCharKey]) {
  // 初回はパフェン付与
  collection.owned.parfen = { owned:true, dup:0, limit:0 };
  saveCollection();
  currentCharKey = 'parfen';
}
updateCharInfo();
let bestScore = loadBestScore();

// ====== ガチャ：確率 & 天井 ======
/*
  確率：C60/R24/E10/L5/M1
  天井：30連でL以上保証 / 100連でM保証
*/
const pityKey = 'psrun_pity_v1';
let pity = loadPity(); // {sinceL:0, sinceM:0}

function rollRarity(){
  const p = Math.random();
  if (p < 0.01) return 'M';
  if (p < 0.06) return 'L';
  if (p < 0.16) return 'E';
  if (p < 0.40) return 'R';
  return 'C';
}
function rollCharByRar(r){
  const pool = Object.values(characters).filter(c=>c.rar===r);
  return pool[Math.floor(Math.random()*pool.length)];
}
function doGacha(n){
  const cost = n===10?100:10;
  if (coins<cost) return;
  coins -= cost;

  // 保障適用のため、結果配列を先にレアだけ決める
  let rarities = [];
  for(let i=0;i<n;i++){
    let r = rollRarity();
    // 30連L保障（sinceL>=29 で次はL以上保証）
    if (pity.sinceL >= 29 && i===0) r = (Math.random()<0.167)?'M':'L';
    rarities.push(r);
  }
  // 100連M保障（sinceM>=99 で最後をMに）
  if (pity.sinceM >= 99) rarities[rarities.length-1] = 'M';

  // 結果生成
  const results = rarities.map(r=>{
    const ch = rollCharByRar(r);
    addToCollection(ch.key);
    // pity更新
    if (r==='M') { pity.sinceM=0; pity.sinceL=0; }
    else if (r==='L') { pity.sinceL=0; pity.sinceM++; }
    else { pity.sinceL++; pity.sinceM++; }
    return ch;
  });
  savePity();
  setHUD(GAME_TIME-(now()-t0));

  // 表示
  resWrap.innerHTML='';
  resWrap.style.gridTemplateColumns = `repeat(${Math.min(5,results.length)},1fr)`;
  results.forEach(ch=>{
    const dv=document.createElement('div');
    dv.className=`miniCard ${rarClass(ch.rar)}`;
    const own = collection.owned[ch.key];
    dv.innerHTML = `<div class="big">${ch.emoji}</div>
      <div>${ch.name}</div>
      <div class="small">R:${ch.rar} / LB:${own.limit}</div>`;
    dv.onclick = ()=>{ setCurrentChar(ch.key); ov.style.display='none'; };
    resWrap.appendChild(dv);
  });
  ov.style.display='flex';
}

function addToCollection(key){
  if (!collection.owned[key]) collection.owned[key] = { owned:true, dup:0, limit:0 };
  else {
    collection.owned[key].dup++;
    // 限界突破ルール（被り強化）
    const rar = characters[key].rar;
    const inc = rar==='M' ? 0.04 : rar==='L' ? 0.03 : rar==='E' ? 0.025 : rar==='R' ? 0.015 : 0.005;
    collection.owned[key].limit = +(collection.owned[key].limit + inc).toFixed(3); // 小数で蓄積
  }
  saveCollection();
}

// コレクションUI
btnCollection.onclick = ()=>{
  colGrid.innerHTML='';
  // ソート：レア→所持→名前
  const list = Object.values(characters).sort((a,b)=>{
    const ra = rarOrder.indexOf(a.rar), rb = rarOrder.indexOf(b.rar);
    if (ra!==rb) return ra-rb;
    const oa = !!collection.owned[a.key], ob = !!collection.owned[b.key];
    if (oa!==ob) return (ob?1:-1);
    return a.name.localeCompare(b.name,'ja');
  });
  list.forEach(ch=>{
    const own = collection.owned[ch.key];
    const dv=document.createElement('div');
    dv.className=`miniCard ${rarClass(ch.rar)}`;
    dv.innerHTML = `<div class="big">${ch.emoji}</div>
      <div>${ch.name}</div>
      <div class="small">${own?`R:${ch.rar} / LB:${own.limit||0}`:'未所持'}</div>`;
    dv.onclick = ()=>{
      colSelectedKey = ch.key;
      colEquip.disabled = !own;
      // 軽い選択ハイライト
      [...colGrid.children].forEach(x=>x.style.outline='none');
      dv.style.outline='2px solid #fff';
    };
    colGrid.appendChild(dv);
  });
  colOv.style.display='flex';
};

// ====== HUD / 便利 ======
function hearts(n){ return '❤️'.repeat(n) + '♡'.repeat(3-n); }
function setHUD(remainMs){
  const sec = Math.max(0, Math.ceil(remainMs/1000));
  const invActive = now()<invUntil;
  const st = stageForLevel(level).name;
  const ch = characters[currentCharKey];
  const own = collection.owned[currentCharKey];
  const lb = own?.limit? own.limit : 0;
  const bestText = (Number.isFinite(bestScore) ? bestScore : 0).toLocaleString('ja-JP');
  const scoreText = score.toLocaleString('ja-JP');
  const coinText = coins.toLocaleString('ja-JP');
  hud.innerHTML = `
    <div class="hudRow">
      <span class="hudItem"><strong>ステージ</strong><span class="value">${st}</span></span>
      <span class="hudItem"><strong>レベル</strong><span class="value">${level}</span></span>
      <span class="hudItem"><strong>残り</strong><span class="value">${sec}秒</span></span>
      ${invActive ? '<span class="hudItem"><span class="hudTag">無敵中</span></span>' : ''}
    </div>
    <div class="hudRow">
      <span class="hudItem hudHearts"><strong>ライフ</strong><span class="value">${hearts(lives)}</span></span>
      <span class="hudItem"><strong>スコア</strong><span class="value">${scoreText}</span></span>
      <span class="hudItem hudCoins"><strong>コイン</strong><span class="value">🪙${coinText}</span></span>
      <span class="hudItem"><strong>必殺</strong><span class="value">${Math.floor(ult)}%</span></span>
      <span class="hudItem"><strong>ベスト</strong><span class="value">${bestText}</span></span>
    </div>`;
  charInfo.textContent = `CHAR: ${ch.emoji} ${ch.name} [${ch.rar}]  LB:${lb}`;
  btnUlt.style.display = ultReady ? 'block':'none';
  btnGacha.disabled = coins < 10;
  btnGacha10.disabled = coins < 100;
}

function refreshHUD(){
  const remain = gameOn ? (GAME_TIME - (now()-t0)) : 0;
  setHUD(remain);
}
const now = ()=>performance.now();
const rand = (a,b)=> a + Math.random()*(b-a);
const AABB = (a,b)=> a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

// ====== スポーン ======
function spawnItem(){
  const isParfait = Math.random()<0.5;
  items.push({
    x: cv.width+24,
    y: cv.height - GROUND - 44 - rand(0, 95),
    w: 30, h: 30,
    v: 3.0 + rand(.6,1.8) + (level-1)*.22,
    char: isParfait ? '🍨' : '🐟',
    score: isParfait ? 2 : 1
  });
}
function spawnEnemy(){
  const st = stageForLevel(level);
  enemies.push({
    x: cv.width+30,
    y: cv.height - GROUND - 36,
    w: 36, h: 36,
    v: (2.7 + (level-1)*.35) * st.enemyMul
  });
}
function spawnPower(){
  powers.push({
    x: cv.width+26,
    y: cv.height - GROUND - 44 - rand(0, 120),
    w: 26, h: 26,
    v: 3.0 + (level-1)*.25
  });
}

// ====== 入力 ======
let canDouble = false, guardReadyTime = 0;
function jump(){
  if (!gameOn) return;
  // 二段ジャンプ判定
  const hasDouble = characters[currentCharKey].special?.includes('doubleJump');
  if (player.onGround){
    player.vy = currentStats.jump; player.onGround=false;
    canDouble = hasDouble; // 地上離陸時に2段目権利付与
  } else if (hasDouble && canDouble){
    player.vy = currentStats.jump * 0.9; // 2段目はやや弱め
    canDouble = false;
  }
}
function shoot(){
  if (!gameOn) return;
  const t=now(); if (t-lastShot<shootCD) return; lastShot=t;
  const pierce = characters[currentCharKey].special?.includes('pierce');
  const v = 9+level*.6 + (now()<bulletBoostUntil? 4:0);
  bullets.push({ x:player.x+player.w, y:player.y+player.h/2-3, w:12, h:6, v: v*currentStats.bullet, hitsLeft: pierce? 2 : 1 });
}
function tryUlt(){
  if (!gameOn||!ultReady) return;
  ultReady=false; ult=0;
  const type = characters[currentCharKey].ult;
  ultProjectiles.length = 0;
  if (type==='storm') {
    ultActiveUntil = now()+1600;
  } else if (type==='ncha') {
    ultActiveUntil = now()+1500;
  } else if (type==='yadon') {
    ultActiveUntil = now()+2600;
    const baseY = player.y + player.h/2;
    const count = 6;
    for (let i=0;i<count;i++){
      const spread = i - (count-1)/2;
      ultProjectiles.push({
        x: player.x + player.w - 8,
        y: baseY + spread*20,
        w: 32,
        h: 32,
        vx: 5.4 + Math.abs(spread)*0.6,
        vy: spread*0.28,
        gravity: 0.08,
        hits: 2,
        char: '🦛',
        expires: now()+2800,
        dead: false,
      });
    }
  } else {
    ultActiveUntil = now()+2000; // rainbowデフォ
  }
}

// PCキー
window.addEventListener('keydown', e=>{
  if (e.code==='Space' || e.code==='ArrowUp') jump();
  if (e.key==='z'||e.key==='x'||e.key==='Z'||e.key==='X') shoot();
  if (e.key==='c' || e.key==='C') tryUlt();
});

// タッチ（左＝ジャンプ、右＝攻撃 or 長押しで必殺）
let pressTimer=null, pressedRight=false;
cv.addEventListener('touchstart', e=>{
  e.preventDefault();
  const rect=cv.getBoundingClientRect();
  const x=e.changedTouches[0].clientX - rect.left;
  const isLeft = x < rect.width/2;
  if (isLeft){ jump(); pressedRight=false; }
  else {
    pressedRight=true;
    pressTimer=setTimeout(()=>{ if(pressedRight) tryUlt(); }, 350);
    shoot();
  }
},{passive:false});
cv.addEventListener('touchend', ()=>{ pressedRight=false; clearTimeout(pressTimer); }, {passive:true});
btnUlt.addEventListener('click', tryUlt);

// ====== キャラ適用 ======
let currentStats = getEffectiveStats(currentCharKey);
function getEffectiveStats(key){
  // 基本
  const ch = characters[key];
  const lb = collection.owned[key]?.limit || 0; // 小数の累積
  // 限界突破ぶんを等倍増加（例：+0.03 なら +3%）
  return {
    move:   ch.move   * (1+lb),
    jump:   BASE_JUMP * ch.jump * (1+lb*0.5), // ジャンプは控えめに反映
    bullet: ch.bullet * (1+lb),
    inv:    Math.floor(ch.inv * (1+lb*0.5)),
    ultRate:ch.ultRate* (1+lb*0.5),
    special: ch.special,
    ult: ch.ult,
  };
}
function setCurrentChar(key){
  currentCharKey = key;
  collection.current = key;
  saveCollection();
  currentStats = getEffectiveStats(key);
  updateCharInfo();
}
function updateCharInfo(){
  const ch = characters[currentCharKey];
  const own = collection.owned[currentCharKey];
  const lb = own?.limit? own.limit : 0;
  charInfo.textContent = `CHAR: ${ch.emoji} ${ch.name} [${ch.rar}]  LB:${lb}`;
}

// ====== 更新 ======
function update(t){
  if(!gameOn) return;
  const elapsed=t-t0, remain=GAME_TIME-elapsed;
  if (remain<=0) return endGame();

  // レベル
  level = Math.max(1, Math.floor(score/itemLv)+1);
  const st = stageForLevel(level);

  // 生成間隔
  const itemIv  = clamp(1200 - (level-1)*100, 480, 1200);
  const enemyIv = clamp(1650 - (level-1)*130, 600, 1650);
  const powerIv = 6200;

  if(t-lastItem  > itemIv)  { spawnItem();  lastItem=t; }
  if(t-lastEnemy > enemyIv) { spawnEnemy(); lastEnemy=t; }
  if(t-lastPower > powerIv) { spawnPower(); lastPower=t; }

  // 物理
  player.vy += G; player.y += player.vy;
  if (player.y+player.h >= cv.height-GROUND){
    player.y=cv.height-GROUND-player.h; player.vy=0; player.onGround=true; canDouble = characters[currentCharKey].special?.includes('doubleJump');
  }

  // オート射撃（ガチャ効果など将来用）
  if (now()<autoShootUntil && t-lastShot>shootCD*0.6){ shoot(); }

  // 弾
  bullets = bullets.filter(b=> {
    b.x += b.v;
    return (b.x < cv.width+24) && b.hitsLeft>0;
  });

  // アイテム（Mythic magnet）
  const hasMagnet = characters[currentCharKey].special?.includes('magnet');
  items = items.filter(it=>{
    // 吸引
    if (hasMagnet){
      const dx = (player.x - it.x), dy = (player.y - it.y);
      const dist = Math.hypot(dx,dy);
      if (dist < 160){
        it.x += dx*0.18; it.y += dy*0.18;
      }
    }
    it.x -= it.v;
    if (AABB(player,it)){
      const mul = now()<scoreMulUntil ? 2 : 1;
      score += it.score*mul; coins += 1 * mul;
      ult = clamp(ult + (it.char==='🍨'?10:6) * currentStats.ultRate, 0, 100);
      return false;
    }
    return it.x+it.w>0;
  });

  // ⭐
  powers = powers.filter(pw=>{
    pw.x -= pw.v;
    if (AABB(player,pw)){ invUntil=now()+Math.max(powerMillis,currentStats.inv); ult=Math.min(100,ult+12*currentStats.ultRate); return false; }
    return pw.x+pw.w>0;
  });

  // 必殺投射体（ヤドン砲）
  ultProjectiles.forEach(p=>{
    p.x += p.vx;
    p.y += p.vy;
    p.vy += p.gravity;
  });

  // 必殺準備
  if (ult>=100) ultReady=true;

  // 敵
  const hasSlow = characters[currentCharKey].special?.includes('slowEnemy');
  enemies = enemies.filter(en=>{
    en.x -= en.v;

    // 必殺
    if (now()<ultActiveUntil){
      const type = characters[currentCharKey].ult;
      if (type==='storm'){
        // 渦：半径120
        const cx = player.x+player.w/2, cy = player.y+player.h/2;
        const ex = en.x+en.w/2, ey = en.y+en.h/2;
        const hit = Math.hypot(cx-ex, cy-ey) <= 120;
        if (hit){ score+=enemyBonus; coins+=2; return false; }
      } else if (type==='ncha'){
        // んちゃ砲：前方ビーム
        const beamX = player.x + player.w - 6;
        const beamTop = player.y - 36;
        const beamBottom = player.y + player.h + 36;
        const hit = (en.x+en.w) >= beamX && en.x <= cv.width && en.y <= beamBottom && (en.y+en.h) >= beamTop;
        if (hit){ score+=enemyBonus; coins+=2; return false; }
      } else {
        // rainbow：3レーン
        const lanes = [player.y + player.h/2, player.y + player.h/2 - 36, player.y + player.h/2 + 36];
        const hit = lanes.some(y=> en.y-6 <= y && y <= en.y+en.h+6);
        if (hit){ score+=enemyBonus; coins+=2; return false; }
      }
    }

    if (characters[currentCharKey].ult==='yadon'){
      for (let i=0;i<ultProjectiles.length;i++){
        const shot = ultProjectiles[i];
        if (!shot || shot.dead) continue;
        if (AABB(en, shot)){
          score+=enemyBonus; coins+=2;
          shot.hits--;
          if (shot.hits<=0) shot.dead=true;
          return false;
        }
      }
    }

    // 弾ヒット（pierce対応）
    for (let i=0;i<bullets.length;i++){
      if (AABB(en,bullets[i])){
        score+=enemyBonus; coins+=2;
        bullets[i].hitsLeft--;
        if (hasSlow) en.v *= 0.6; // 一時的スロー（簡易）
        if (bullets[i].hitsLeft<=0) bullets.splice(i,1);
        return false;
      }
    }

    // 体当たり
    if (AABB(player,en)){
      if (now()<invUntil){ score+=enemyBonus; coins+=2; return false; }
      // oneGuard（7秒CD）
      const hasGuard = characters[currentCharKey].special?.includes('oneGuard');
      if (hasGuard && now() - guardReadyTime > 7000){
        guardReadyTime = now(); // ノーダメで守る
        return false;
      }
      if (now()>hurtUntil){
        lives=Math.max(0,lives-1); hurtUntil=now()+900;
        if (lives===0){ endGame(); return false; }
      }
    }
    return en.x+en.w>0;
  });

  ultProjectiles = ultProjectiles.filter(p=> !p.dead && now()<p.expires && p.x<cv.width+60 && p.y>-80 && p.y<cv.height+80 && p.hits>0);

  draw(remain, st);
  requestAnimationFrame(update);
}

// ====== 描画 ======
function draw(remain, st){
  const g=c.createLinearGradient(0,0,0,cv.height);
  g.addColorStop(0, st.bg1); g.addColorStop(1, st.bg2);
  c.fillStyle=g; c.fillRect(0,0,cv.width,cv.height);
  c.fillStyle=st.ground; c.fillRect(0, cv.height-GROUND, cv.width, GROUND);

  if (now()<invUntil){ c.strokeStyle='#f5c542'; c.lineWidth=4; c.strokeRect(player.x-2,player.y-2,player.w+4,player.h+4); }
  const blink = now()<hurtUntil && Math.floor(now()/60)%2===0;
  if (!blink){ c.fillStyle=player.color; c.fillRect(player.x,player.y,player.w,player.h); }

  // 必殺描画
  if (now()<ultActiveUntil){
    const type = characters[currentCharKey].ult;
    if (type==='storm'){
      const cx = player.x+player.w/2, cy = player.y+player.h/2;
      c.fillStyle='rgba(80,160,255,.25)'; c.beginPath(); c.arc(cx,cy,120,0,Math.PI*2); c.fill();
      c.strokeStyle='rgba(200,230,255,.7)'; c.lineWidth=3; c.beginPath(); c.arc(cx,cy,88,0,Math.PI*2); c.stroke();
    } else if (type==='ncha'){
      const beamX = player.x + player.w - 6;
      const beamTop = player.y - 36;
      const beamH = player.h + 72;
      const intensity = 0.45 + 0.25 * ((Math.sin(now()/90)+1)/2);
      c.fillStyle=`rgba(255,235,59,${intensity})`; c.fillRect(beamX, beamTop, cv.width-beamX, beamH);
      c.fillStyle='rgba(255,255,255,0.8)'; c.fillRect(beamX, beamTop + beamH/2 - 6, cv.width-beamX, 12);
    } else if (type==='yadon'){
      const auraPulse = 40 + Math.sin(now()/140)*6;
      c.strokeStyle='rgba(255,192,203,0.7)';
      c.lineWidth=6;
      c.beginPath(); c.arc(player.x+player.w/2, player.y+player.h/2, auraPulse, 0, Math.PI*2); c.stroke();
    } else {
      const laneYs = [player.y + player.h/2, player.y + player.h/2 - 36, player.y + player.h/2 + 36];
      laneYs.forEach((y,idx)=>{
        c.fillStyle=`rgba(${180+idx*25},${80+idx*50},255,.65)`; c.fillRect(player.x, y-6, cv.width-player.x, 12);
        c.fillStyle='rgba(255,255,255,.55)'; c.fillRect(player.x, y-2, cv.width-player.x, 4);
      });
    }
  }

  // 弾
  c.fillStyle='#333'; bullets.forEach(b=> c.fillRect(b.x,b.y,b.w,b.h));

  // アイテム
  c.font='28px serif'; c.textBaseline='top';
  items.forEach(it=> c.fillText(it.char,it.x,it.y));

  // ヤドン砲の群れ
  if (ultProjectiles.length){
    c.font='32px serif';
    ultProjectiles.forEach(p=>{
      const fade = Math.max(0.35, Math.min(1, (p.expires - now())/400));
      c.save();
      c.globalAlpha = fade;
      c.fillText(p.char, p.x, p.y);
      c.restore();
    });
  }

  // ⭐
  powers.forEach(pw=>{ c.font='26px serif'; c.fillText('⭐', pw.x, pw.y); });

  // 敵
  enemies.forEach(en=>{ c.font='32px serif'; c.fillText('👾', en.x, en.y-4); });

  setHUD(remain);
}

// ====== 開始/終了 ======
function startGame(){
  score=0; level=1; lives=3; invUntil=0; hurtUntil=0; ult=0; ultReady=false; ultActiveUntil=0;
  coins=0; autoShootUntil=0; bulletBoostUntil=0; scoreMulUntil=0;
  items.length=0; enemies.length=0; bullets.length=0; powers.length=0; ultProjectiles.length=0;
  player.x=120; player.y=cv.height-GROUND-player.h; player.vy=0; player.onGround=true;
  canDouble = characters[currentCharKey].special?.includes('doubleJump');
  guardReadyTime = 0;
  btnStart.style.display='none'; btnRestart.style.display='none';
  t0=now(); gameOn=true;
  lastItem=lastEnemy=lastPower=lastShot=t0;
  currentStats = getEffectiveStats(currentCharKey);
  setHUD(GAME_TIME); draw(GAME_TIME, stageForLevel(level));
  requestAnimationFrame(update);
}
function endGame(){
  if(!gameOn) return; gameOn=false;
  const st = stageForLevel(level);
  draw(0, st);
  c.fillStyle='rgba(0,0,0,.55)'; c.fillRect(0,0,cv.width,cv.height);
  c.fillStyle='#fff'; c.textAlign='center';
  c.font='36px sans-serif'; c.fillText('ゲーム終了！', cv.width/2, cv.height/2 - 24);
  c.font='24px sans-serif'; c.fillText(`最終スコア: ${score}　レベル: ${level}　コイン: 🪙${coins}`, cv.width/2, cv.height/2 + 10);
  const finalResult = { score, level, coins, char: currentCharKey };
  updateBestScore(finalResult.score);
  c.textAlign='start'; btnRestart.style.display='inline-block';
  setTimeout(()=>{ handleLeaderboardAfterGame(finalResult).catch(err=>console.error(err)); }, 200);
}

// ====== ボタン ======
btnStart.addEventListener('click', startGame);
btnRestart.addEventListener('click', startGame);

btnHow.addEventListener('click', ()=>{
  alert(
    '▶ 基本ルール\n' +
    '・スタートで60秒ラン開始。敵を避けつつ🍨や🐟を集めてスコアを伸ばそう。\n' +
    '・ダメージを受けるとライフ減。ゼロになるとゲーム終了。\n\n' +
    '▶ 操作（タッチ・マウス共通）\n' +
    '・画面左タップ：ジャンプ（対応キャラは二段ジャンプ可）。\n' +
    '・画面右タップ：攻撃。右長押し or 右下「必殺」でゲージ100%時に必殺技。\n' +
    '・キーボード：Space/↑＝ジャンプ、Z/X＝攻撃、C＝必殺技。\n\n' +
    '▶ コインとガチャ\n' +
    '・敵撃破やアイテムでコイン獲得。1回10コイン、10連100コイン。\n' +
    '・30連でレジェンド保証 / 100連でミシック保証。\n\n' +
    '▶ コレクション\n' +
    '・引いたキャラは自動登録。重複で限界突破して性能が少しアップ。\n' +
    '・装備したキャラの特性や必殺を活かしてハイスコアを狙おう！\n\n' +
    '▶ Legendaryキャラ\n' +
    '・👑キング：虹レーザー。\n' +
    '・🤖んちゃマシン：んちゃ砲。\n' +
    '▶ Mythicキャラ\n' +
    '・🌈オーロラ：吸引＋一度だけガード。必殺はレインボーレーザー。\n' +
    '・🌀鰯王：二段ジャンプ＋貫通弾。必殺はトルネード攻撃。\n' +
    '・🦛ヤドン：ヤドン砲。'
  );
});

// ====== スポーンと攻撃トリガ ======
function shootIfAuto(t){ /* 予備フック */ }

// ====== ガチャボタン ======
btnGacha.onclick = ()=> doGacha(1);
btnGacha10.onclick = ()=> doGacha(10);

// ====== ストレージ ======
function loadCollection(){
  try{
    const s = localStorage.getItem(STORE_KEY);
    if (s) return JSON.parse(s);
  }catch{}
  return { current:'parfen', owned: { parfen:{owned:true,dup:0,limit:0} } };
}
function saveCollection(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(collection)); }catch{} }
function loadPity(){
  try{ const s = localStorage.getItem(pityKey); if(s) return JSON.parse(s); }catch{}
  return { sinceL:0, sinceM:0 };
}
function savePity(){ try{ localStorage.setItem(pityKey, JSON.stringify(pity)); }catch{} }

function loadBestScore(){
  try{
    const raw = localStorage.getItem(BEST_SCORE_KEY);
    if (raw !== null){
      const value = Number(raw);
      if (Number.isFinite(value)) return Math.max(0, Math.floor(value));
    }
  }catch{}
  return 0;
}

function saveBestScore(){
  try{ localStorage.setItem(BEST_SCORE_KEY, `${bestScore}`); }catch{}
}

function updateBestScore(latestScore){
  const normalized = Math.max(0, Math.floor(Number(latestScore) || 0));
  if (normalized > bestScore){
    bestScore = normalized;
    saveBestScore();
    refreshHUD();
  }
}

// ====== 初期HUD ======
setHUD(GAME_TIME);
updateCharInfo();
loadLeaderboard(false);
})();
</script>
</body>
</html>
