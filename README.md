# パフェとイワシ RUN! – コードベース概要ガイド

## 1. プロジェクト概要
このリポジトリは、HTML 1 ファイル (`index.html`) にゲームロジックとスタイルをすべて内包したカジュアルランゲームです。ブラウザ上で即座に実行可能で、ビルドや依存関係は不要です。エントリーポイントは `<script>` タグ内の即時実行関数 (`(()=>{ ... })();`) で、ページ読み込み完了時点でゲームの初期化が行われます。

## 2. ディレクトリ構成
```
├─ index.html  … 画面レイアウト、スタイル、ゲームロジックを一体化した単一ファイル
```
ゲームを把握する際は、`index.html` の大まかなセクションを順に読み進めるのが最短です。

## 3. コード主要セクション
`index.html` 内のスクリプトは大きく以下のブロックに分かれています。

| セクション | 内容の要約 |
|-------------|------------|
| UI 要素の取得 | `document.getElementById` でボタン、HUD、オーバーレイ等を取得します。【F:index.html†L75-L129】 |
| 定数とステート | 重力・ゲーム時間などの定数、スコアやライフ等のゲーム状態を管理します。【F:index.html†L131-L184】 |
| ステージ & キャラクター定義 | 背景テーマとキャラクター性能・必殺技・レア度情報を配列/オブジェクトで宣言します。【F:index.html†L186-L258】 |
| コレクション/ガチャ管理 | 所持キャラや天井カウンターを `localStorage` に保存し、ガチャ演出・UI を描画します。【F:index.html†L260-L368】 |
| 入力処理 | キーボードおよびタッチ操作でジャンプ・攻撃・必殺技を発火します。【F:index.html†L414-L464】 |
| ステータス計算 | 限界突破値を反映した実効ステータスを計算し、ゲーム中に更新します。【F:index.html†L466-L508】 |
| ゲームループ | `requestAnimationFrame` を用い、スポーン処理・衝突判定・描画・HUD 更新を行います。【F:index.html†L342-L413】【F:index.html†L508-L628】 |
| 開始/終了制御 | スタート/リスタート時の初期化とゲーム終了処理をまとめています。【F:index.html†L630-L708】 |
| ボタンイベント | 「スタート」「遊び方」「ガチャ」「コレクション」等の UI 操作を定義します。【F:index.html†L710-L768】 |

## 4. 知っておくべき重要事項
- **単一ファイル構成**：構造・スタイル・ロジックが混在するため、セクションコメント (`// ======`) を目印に移動すると読みやすくなります。
- **ローカル保存**：ガチャで獲得したキャラや天井カウンターは `localStorage` (`psrun_char_collection_v1` / `psrun_pity_v1`) に保存されます。挙動確認時はブラウザのストレージをクリアして初期状態に戻せます。【F:index.html†L320-L340】
- **ベストスコア**：最高スコアは `localStorage` (`psrun_best_score_v1`) に保存され、HUD の「ベスト」に反映されます。【F:index.html†L450-L468】【F:index.html†L915-L934】
- **ゲームバランス**：`characters` オブジェクトに性能倍率や必殺技種別がまとまっているため、調整はここを中心に行います。【F:index.html†L294-L314】
- **必殺技処理**：必殺技は `ultActiveUntil` を使って時間制御され、キャラごとのタイプ (`rainbow`/`storm`) で演出と効果が切り替わります。【F:index.html†L509-L600】
- **当たり判定**：矩形同士 (`AABB`) による簡易判定でアイテム・敵・弾の衝突を管理しています。パフォーマンスはスプライト数が増えた際に影響を受ける可能性があるため注意してください。【F:index.html†L476-L482】【F:index.html†L548-L600】

## 5. 次に学習・理解すると良いポイント
1. **ゲームループの流れ**：`update()` 関数の中で各エンティティ配列を更新・描画し、終了条件を判断しています。先にフロー図を紙に落とし込むと理解が進みます。【F:index.html†L622-L740】
2. **キャラクター拡張**：新キャラを追加する場合は `characters` に定義を追加し、必要なら必殺技タイプやスペシャル効果に新しい分岐を実装します。
3. **UI イベントの把握**：ボタンやオーバーレイ操作は後半にまとまっているため、ユーザー操作からゲーム状態がどう変化するかを追跡しましょう。【F:index.html†L710-L768】
4. **データ保存形式**：`collection.owned` の構造 (`{ owned: true, dup: number, limit: number }`) や天井カウンターのリセット条件を確認し、データ仕様をドキュメント化するのがおすすめです。【F:index.html†L308-L368】
5. **描画最適化の検討**：現在は `CanvasRenderingContext2D` を直接操作しています。エフェクトや背景の改修を行う場合、描画負荷やデバイス幅への対応方法を事前に整理すると良いでしょう。【F:index.html†L576-L600】

## 6. 開発フローのヒント
- ローカルで編集した後はブラウザで `index.html` を直接開いて挙動確認ができます。
- デバッグにはブラウザの DevTools を活用し、`localStorage` の状態を監視したり、`performance.now()` ベースの時間計測をチェックしてください。
- 改修量が増えてきたら、JS/ CSS を外部ファイルに分割し、モジュール化すると保守性が上がります。

### 簡易サーバーの利用
`server.js` は静的ファイルを配信するだけの軽量サーバーです。開発中に `node server.js` を実行すると `http://localhost:3000` でゲームを確認できます。【F:server.js†L1-L39】

## 7. 将来的な改善アイデア
- ステージや敵パターンの追加、難易度曲線の再設計
- `requestAnimationFrame` ループの負荷計測とスプライト最適化
- UI/UX：レスポンシブレイアウトの調整、チュートリアル表示の追加
- セーブデータ管理：バージョン管理とマイグレーション処理の導入

このガイドを起点にコードを読み解き、目的のセクションから掘り下げていってください。必要に応じてメモや図解を作成しながら理解を進めるとスムーズです。

## 8. WordPress REST API リーダーボード連携
- ゲーム終了時にスコアが 0 より大きい場合は名前入力ダイアログが表示され、外部の WordPress REST API (`/wp-json/psrun/v1/leaderboard`) へスコアを送信します。送信が失敗した場合はアラートとランキングオーバーレイ内のメッセージで通知します。【F:index.html†L356-L408】【F:index.html†L1045-L1048】
- 「ランキング」ボタンで開くオーバーレイでは最大 20 件の結果を表示し、API から返却された名前・スコア・レベル・コイン・キャラ・登録時刻を並べます。結果が空のときは “No results yet” と表示されます。【F:index.html†L195-L208】【F:index.html†L296-L348】
- API ベース URL は既定で `https://howasaba-code.com/wp-json/psrun/v1/leaderboard` を指します。開発や検証で別環境を使いたい場合は、`window.PSRUN_API_BASE` でベースパスを上書きできます。例：`<script>window.PSRUN_API_BASE='https://example.com/wp-json/psrun/v1';</script>` を `index.html` に追加すると、そのドメインの `/leaderboard` エンドポイントに対して通信します。【F:index.html†L262-L287】
