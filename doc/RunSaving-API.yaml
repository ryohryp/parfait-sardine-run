openapi: 3.0.3
info:
  title: PSR Run Saving API (UPSERT V1.1)
  description: |
    Parfait & Sardine RUN! (PSR) のゲーム実行データを保存・取得するためのAPI。
    ユーザーごとに最新の情報 (ベストスコアや最終結果) を1行に保持するUPSERT（更新/挿入）モデルを採用しています。
  version: v1.1
servers:
  - url: /{base_url}/wp-json/psr/v1
    variables:
      base_url:
        default: https://example.com # 実際のWordPressサイトのドメインに置き換えてください
        description: WordPressサイトのベースURL
tags:
  - name: Run Management
    description: ゲームの開始、終了、ステータス確認
  - name: Data Query
    description: ユーザーデータおよび統計情報の取得

paths:
  /run/start:
    post:
      tags:
        - Run Management
      summary: ランの開始とユーザー情報の更新
      operationId: startRun
      description: |
        新しいゲームの実行を開始し、ユーザーの基本情報を更新します（UPSERT操作）。
        成功した場合、後続の `/run/finish` や `/run/heartbeat` で利用する **run_id** と **nonce** を返します。
        **レート制限** (`PSR_RATE_START_SEC`秒ごと) が適用されます。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunStartRequest'
      responses:
        '201':
          description: ランが正常に開始され、ユーザー情報が更新されました。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStartResponse'
              example:
                run_id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
                nonce: "abcdefg12345hijklmn6789opqrst0123"
                started_gmt: "2025-11-23 09:30:00"
        '400':
          description: 必須フィールド不足 (`fingerprint is required`)。
        '403':
          description: CORSオリジン不許可。
        '429':
          description: レート制限オーバー (`Too Many Requests`)。
        '500':
          description: データベースエラー (`failed to upsert user`)。

  /run/finish:
    post:
      tags:
        - Run Management
      summary: ランの終了と結果の保存
      operationId: finishRun
      description: |
        実行中のゲームの結果を、`/run/start` で受け取った **run_id** と **nonce** を使用して保存します。
        `psr_users` テーブルの**スコア、ベストスコア、実行回数**などが更新されます。
        `PSR_KEEP_RUNS` が `true` の場合、`psr_runs` テーブルにも履歴が記録されます。
        **レート制限** (`PSR_RATE_FINISH_SEC`秒ごと) が適用されます。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunFinishRequest'
      responses:
        '200':
          description: ランの結果が正常に保存されました。
          content:
            application/json:
              schema:
                type: object
                properties:
                  run_id: { type: string, format: uuid }
                  saved: { type: boolean, example: true }
              example:
                run_id: "a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"
                saved: true
        '400':
          description: |
            必須フィールド不足 (`missing fields`)、無効な run_id/nonce (`invalid nonce` / `run not found`)、またはメトリクスが無効 (`invalid metrics`)。
        '403':
          description: CORSオリジン不許可。
        '429':
          description: レート制限オーバー (`Too Many Requests`)。
        '500':
          description: データベース更新エラー (`failed to finish run`)。

  /run/heartbeat:
    post:
      tags:
        - Run Management
      summary: ランの生存確認 (Nonce検証)
      operationId: runHeartbeat
      description: |
        実行中のランの **run_id** と **nonce** が有効であることを確認します（主な用途は不正防止）。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [run_id, nonce]
              properties:
                run_id: { type: string, format: uuid }
                nonce: { type: string }
      responses:
        '200':
          description: 検証成功。
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
        '400':
          description: 無効な run_id/nonce (`invalid nonce` / `run not found`)。
        '403':
          description: CORSオリジン不許可。

  /runs:
    get:
      tags:
        - Data Query
      summary: ユーザーのラン履歴または最新結果の取得
      operationId: getRunsQuery
      description: |
        指定されたユーザー (`fingerprint`) のランデータを取得します。
        - **`PSR_KEEP_RUNS: false` (デフォルト):** `psr_users` テーブルから最新の実行結果（1件）を返します。
        - **`PSR_KEEP_RUNS: true`:** `psr_runs` テーブルからラン履歴をページング形式で返します。
        **レート制限** (`PSR_RATE_QUERY_SEC`秒ごと) が適用されます。
      parameters:
        - in: query
          name: fingerprint
          required: true
          schema: { type: string }
          description: ユーザーを識別するための生のフィンガープリント文字列。
        - in: query
          name: page
          required: false
          schema: { type: integer, default: 1 }
          description: ページ番号 (`PSR_KEEP_RUNS: true` の場合のみ有効)
        - in: query
          name: per_page
          required: false
          schema: { type: integer, default: 20 }
          description: 1ページあたりの件数 (`PSR_KEEP_RUNS: true` の場合のみ有効)
      responses:
        '200':
          description: 成功。ランデータまたは空のリストを返します。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunsQueryResponse'
              example:
                page: 1
                per_page: 1
                total: 1
                runs:
                  - run_id: "a1b2c3d4-..."
                    nickname: "PlayerOne"
                    score: 15000
                    stage: "Stage_3"
                    duration_ms: 120000
                    distance: 5000
                    coins: 150
                    result: "clear"
                    finished_gmt: "2025-11-23 10:00:00"
                    runs_count: 10 # PSR_KEEP_RUNS: false の場合のみ追加される
                    score_best: 18000 # PSR_KEEP_RUNS: false の場合のみ追加される
        '400':
          description: `fingerprint required`。
        '403':
          description: CORSオリジン不許可。
        '429':
          description: レート制限オーバー (`Too Many Requests`)。

  /stats/summary:
    get:
      tags:
        - Data Query
      summary: ゲーム全体の統計情報の取得
      operationId: getStatsSummary
      description: |
        ゲーム全体の集計データを提供します。`PSR_KEEP_RUNS` の設定に応じて、集計対象が `psr_users` (per-user) または `psr_runs` (per-run) に切り替わります。
      responses:
        '200':
          description: 成功。集計データを返します。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsSummaryResponse'
              example:
                total_users: 1000
                played_users: 850
                today_users: 50
                total_runs: 5500
                avg_score: 8500
                max_score: 35000
                device_ratio:
                  - device: "PC_Web"
                    cnt: 600
                  - device: "Mobile_Android"
                    cnt: 250
        '403':
          description: CORSオリジン不許可。

components:
  schemas:
    RunStartRequest:
      type: object
      required:
        - fingerprint
      properties:
        fingerprint:
          type: string
          description: ユーザーを識別するための生のフィンガープリント文字列。これを基にサーバー側でハッシュ化されます。
          maxLength: 128
        nickname:
          type: string
          description: プレイヤーが設定したニックネーム。
          maxLength: 64
        device:
          type: string
          description: 実行デバイス情報（例: 'PC_Web', 'Mobile_iOS'）。
          maxLength: 32
        build:
          type: string
          description: ゲームのビルド/バージョン情報。
          maxLength: 32

    RunStartResponse:
      type: object
      properties:
        run_id:
          type: string
          format: uuid
          description: このランを一意に識別するためのUUID。
        nonce:
          type: string
          description: このランの完了時に検証するための使い捨てトークン。
        started_gmt:
          type: string
          format: date-time
          description: ランが開始された日時 (GMT)。

    RunFinishRequest:
      type: object
      required:
        - run_id
        - nonce
        - score
        - stage
        - duration_ms
      properties:
        run_id: { type: string, format: uuid, description: `/run/start` で受け取ったランID。 }
        nonce: { type: string, description: `/run/start` で受け取ったノンス。 }
        score: { type: integer, format: int64, description: 最終スコア。 }
        stage: { type: string, description: 最終到達ステージ。 }
        duration_ms: { type: integer, description: 実行時間（ミリ秒）。 }
        distance: { type: integer, description: 移動距離 (任意)。 }
        coins: { type: integer, description: 獲得コイン数 (任意)。 }
        result:
          type: string
          enum: [clear, lose, quit]
          description: ゲームの終了結果 (任意)。
        extras:
          type: object
          nullable: true
          description: その他のカスタムデータ（`PSR_KEEP_RUNS: true` の場合のみ `psr_runs` にJSONとして保存）。

    RunData:
      type: object
      properties:
        run_id: { type: string, format: uuid }
        nickname: { type: string, nullable: true }
        score: { type: integer, format: int64, nullable: true }
        stage: { type: string, nullable: true }
        duration_ms: { type: integer, nullable: true }
        distance: { type: integer, nullable: true }
        coins: { type: integer, nullable: true }
        result: { type: string, enum: [clear, lose, quit], nullable: true }
        device: { type: string, nullable: true }
        build: { type: string, nullable: true }
        extras: { type: object, nullable: true }
        started_gmt: { type: string, format: date-time, nullable: true }
        finished_gmt: { type: string, format: date-time, nullable: true }

    RunsQueryResponse:
      type: object
      properties:
        page: { type: integer }
        per_page: { type: integer }
        total: { type: integer }
        runs:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/RunData'
              - type: object
                properties:
                  runs_count:
                    type: integer
                    description: ユーザーの総実行回数 (`PSR_KEEP_RUNS: false` の場合のみ)
                  score_best:
                    type: integer
                    format: int64
                    description: ユーザーのベストスコア (`PSR_KEEP_RUNS: false` の場合のみ)

    StatsSummaryResponse:
      type: object
      description: ゲーム全体の統計情報
      properties:
        total_users:
          type: integer
          description: 総ユーザー数 (`PSR_KEEP_RUNS: false` の場合)
        played_users:
          type: integer
          description: ランを完了したユーザー数 (`PSR_KEEP_RUNS: false` の場合)
        today_users:
          type: integer
          description: 当日ランを完了したユーザー数 (`PSR_KEEP_RUNS: false` の場合)
        total_runs:
          type: integer
          description: 総実行回数 (`PSR_KEEP_RUNS` の設定に応じて集計元が変わる)
        today_runs:
          type: integer
          description: 当日実行回数 (`PSR_KEEP_RUNS: true` の場合のみ)
        avg_score: { type: integer, format: int64, description: 平均スコア }
        max_score: { type: integer, format: int64, description: 最高スコア }
        device_ratio:
          type: array
          description: デバイスごとの集計件数
          items:
            type: object
            properties:
              device: { type: string }
              cnt: { type: integer }